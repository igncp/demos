
  <!DOCTYPE html>
  <html>
    <head>
      <title>ThreeJSCubeWater.stories.tsx</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx</td><td class="">97.65%</td><td class="">95%</td><td class="">425</td><td class="">415</td><td class="">10</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import React from &quot;react&quot;
import {
  ACESFilmicToneMapping,
  BoxGeometry,
  MathUtils,
  Mesh,
  MeshStandardMaterial,
  PMREMGenerator,
  PerspectiveCamera,
  PlaneGeometry,
  RepeatWrapping,
  Scene,
  TextureLoader,
  Vector3,
  WebGLRenderer,
} from &quot;three&quot;
import { OrbitControls } from &quot;three/examples/jsm/controls/OrbitControls.js&quot;
import { Sky } from &quot;three/examples/jsm/objects/Sky.js&quot;
import { Water } from &quot;three/examples/jsm/objects/Water.js&quot;

import { StoryInfo, TemplateType, createRangeControl } from &quot;../common&quot;

import waterTexture from &quot;./waternormals.jpg&quot;

type Props = {
  speed: number
}

const ROOT_ID = &quot;example&quot;

const planeSize = 10_000
const textureSize = 512
const boxSize = 30
const sunColor = 0xffffff
const waterColor = 0x001e0f

const createControls = ({
  camera,
  renderer,
}: {
  camera: PerspectiveCamera
  renderer: WebGLRenderer
}) =&gt; {
  const controls = new OrbitControls(camera, renderer.domElement)

  controls.maxPolarAngle = Math.PI * 0.495
  controls.target.set(0, 10, 0)
  controls.minDistance = 40.0
  controls.maxDistance = 200.0
  controls.update()
}

type State = {
  isStopped: boolean
  timePassed: number
}

type SimulationElements = {
  boxMesh: Mesh
  camera: PerspectiveCamera
  renderer: WebGLRenderer
  scene: Scene
  sky: Sky
  sun: THREE.Vector3
  water: Water
}

type Simulation = {
  elements: SimulationElements
  props: Props
  state: State
  stop: () =&gt; void
}

const createDemo = ({
  prevSimulation,
  props,
}: {
  prevSimulation: Simulation | null
  props: Props
}): Simulation =&gt; {
  const state: State = {
    timePassed: 0,
    ...(prevSimulation?.state ?? {}),
    isStopped: false,
  }

  const container = document.getElementById(ROOT_ID) as HTMLElement

  const height = 500
  const { width } = container.getBoundingClientRect()

  const elements = ((): SimulationElements =&gt; {
    if (prevSimulation) {
      return prevSimulation.elements
    }

    const scene = new Scene()
    const waterGeometry = new PlaneGeometry(planeSize, planeSize)
    const water = new Water(waterGeometry, {
      distortionScale: 3.7,
      sunColor,
      sunDirection: new Vector3(),
      textureHeight: textureSize,
      textureWidth: textureSize,
      waterColor,
      waterNormals: new TextureLoader().load(waterTexture, (texture) =&gt; {
        texture.wrapS = RepeatWrapping
        texture.wrapT = RepeatWrapping
      }),
    })
    const sun = new Vector3()

    scene.add(water)

    const sky = new Sky()

    sky.scale.setScalar(planeSize)
    scene.add(sky)

    const boxGeometry = new BoxGeometry(boxSize, boxSize, boxSize)
    const boxMaterial = new MeshStandardMaterial({ roughness: 0 })

    const boxMesh = new Mesh(boxGeometry, boxMaterial)

    scene.add(boxMesh)

    const camera = new PerspectiveCamera(55, width / height, 1, 20000)
    const renderer = new WebGLRenderer()

    return {
      boxMesh,
      camera,
      renderer,
      scene,
      sky,
      sun,
      water,
    }
  })()

  const { boxMesh, camera, renderer, scene, sky, sun, water } = elements

  const onWindowResize = () =&gt; {
    camera.aspect = width / height
    camera.updateProjectionMatrix()

    renderer.setSize(width, height)
  }

  window.addEventListener(&quot;resize&quot;, onWindowResize)

  const createSimulation = () =&gt; ({
    elements,
    props,
    state,
    stop: () =&gt; {
      window.removeEventListener(&quot;resize&quot;, onWindowResize)
      state.isStopped = true
    },
  })

  const render = () =&gt; {
    state.timePassed += props.speed / 10000

    boxMesh.position.y = Math.sin(state.timePassed) * 25 + 5
    boxMesh.rotation.x = state.timePassed * 0.5
    boxMesh.rotation.z = state.timePassed * 0.51

    const waterMaterial = water.material as THREE.ShaderMaterial

    waterMaterial.uniforms[&quot;time&quot;].value += 1.0 / 60.0 // eslint-disable-line id-denylist

    renderer.render(scene, camera)
  }

  const animate = () =&gt; {
    if (state.isStopped) {
      return
    }

    requestAnimationFrame(animate)
    render()
  }

  if (prevSimulation) {
    animate()

    return createSimulation()
  }

  const setupNewSimulation = () =&gt; {
    container.innerHTML = &quot;&quot;

    renderer.setPixelRatio(window.devicePixelRatio)
    renderer.setSize(width, height)
    renderer.toneMapping = ACESFilmicToneMapping
    container.appendChild(renderer.domElement)

    camera.position.set(30, 30, 100)

    water.rotation.x = -Math.PI / 2

    const {
      material: { uniforms: skyUniforms },
    } = sky

    /* eslint-disable id-denylist */
    skyUniforms[&quot;turbidity&quot;].value = 10
    skyUniforms[&quot;rayleigh&quot;].value = 2
    skyUniforms[&quot;mieCoefficient&quot;].value = 0.005
    skyUniforms[&quot;mieDirectionalG&quot;].value = 0.8
    /* eslint-enable id-denylist */

    const pmremGenerator = new PMREMGenerator(renderer)

    const updateSun = () =&gt; {
      const parameters = {
        azimuth: 180,
        elevation: 2,
      }
      const phi = MathUtils.degToRad(90 - parameters.elevation)
      const theta = MathUtils.degToRad(parameters.azimuth)

      sun.setFromSphericalCoords(1, phi, theta)

      sky.material.uniforms[&quot;sunPosition&quot;].value.copy(sun)
      ;(water.material as THREE.ShaderMaterial).uniforms[&quot;sunDirection&quot;].value
        .copy(sun)
        .normalize()

      scene.environment = pmremGenerator.fromScene(sky as any).texture // eslint-disable-line @typescript-eslint/no-explicit-any
    }

    updateSun()

    createControls({ camera, renderer })
  }

  setupNewSimulation()

  animate()

  return createSimulation()
}

const ThreeJSCubeWater = (props: Props) =&gt; {
  const simulationRef = React.useRef&lt;Simulation | null&gt;(null)
  const [isReadyToRender, setIsReadyToRender] = React.useState(false)

  React.useEffect(() =&gt; {
    const onFinish = () =&gt; {
      setIsReadyToRender(true)
    }

    const img = document.createElement(&quot;img&quot;)

    img.src = waterTexture
    img.onload = onFinish
    img.onerror = onFinish
  }, [])

  React.useEffect(() =&gt; {
    if (!isReadyToRender) {
      return () =&gt; {}
    }

    simulationRef.current = createDemo({
      prevSimulation: simulationRef.current,
      props,
    })

    return () =&gt; {
      if (simulationRef.current) {
        simulationRef.current.stop()
      }
    }
  }, [props, isReadyToRender])

  return (
    &lt;div&gt;
      &lt;StoryInfo
        docs={[]}
        source=&quot;https://github.com/mrdoob/three.js/blob/dev/examples/webgl_shaders_ocean.html&quot;
        sourceText=&quot;Source (official example, ported to TS)&quot;
        storyName=&quot;ThreeJSCubeWater&quot;
      /&gt;
      &lt;div id={ROOT_ID} /&gt;
    &lt;/div&gt;
  )
}

const Template = ((props: Props) =&gt; (
  &lt;ThreeJSCubeWater {...props} /&gt;
)) as TemplateType&lt;Props&gt;

export const Common = Template.bind({})

const [speedArgs, speedControls] = createRangeControl({
  diffMin: 100,
  initialValue: 100,
  step: 1,
})

const args: Props = {
  speed: speedArgs,
}

Common.args = args

export default {
  argTypes: {
    speed: speedControls,
  },
  component: ThreeJSCubeWater,
  title: &quot;ThreeJS/Cube Water&quot;,
}
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:171,&quot;character&quot;:35,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:208,&quot;character&quot;:29,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:209,&quot;character&quot;:28,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:210,&quot;character&quot;:34,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:211,&quot;character&quot;:35,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:226,&quot;character&quot;:43,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:226,&quot;character&quot;:49,&quot;text&quot;:&quot;copy&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:227,&quot;character&quot;:73,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:228,&quot;character&quot;:9,&quot;text&quot;:&quot;copy&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;storybook/stories/ThreeJSCubeWater/ThreeJSCubeWater.stories.tsx&quot;,&quot;line&quot;:229,&quot;character&quot;:9,&quot;text&quot;:&quot;normalize&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Tue, 14 Sep 2021 21:54:00 GMT</p>
    </body>
  </html>
  