
  <!DOCTYPE html>
  <html>
    <head>
      <title>collapsible-tree-chart.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/demos/collapsible-tree/collapsible-tree-chart.ts</td><td class="">100.00%</td><td class="">95%</td><td class="">562</td><td class="">562</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
  D3DragEvent,
  HierarchyPointLink,
  HierarchyPointNode,
  Selection,
  drag,
  hierarchy,
  select,
  tree as treeD3,
} from &quot;d3&quot;

import { UILink } from &quot;./collapsible-tree-chart-ui-link&quot;
import { UINode } from &quot;./collapsible-tree-chart-ui-node&quot;
import * as styles from &quot;./collapsible-tree.module.css&quot;

const inlineStyles = {
  linkDefaultColor: &quot;#555&quot;,
} as const

type NodeShape&lt;Content&gt; = Content &amp; {
  children?: Array&lt;NodeShape&lt;Content&gt;&gt;
}

const findNode = &lt;NodeData&gt;({
  getId,
  node,
  nodeId,
}: {
  getId: (node: NodeShape&lt;NodeData&gt;) =&gt; number
  node: NodeShape&lt;NodeData&gt;
  nodeId: number
}): NodeShape&lt;NodeData&gt; | null =&gt; {
  if (getId(node) === nodeId) {
    return node
  }

  return (node.children ?? []).reduce&lt;NodeShape&lt;NodeData&gt; | null&gt;(
    (...[acc, otherNode]) =&gt;
      acc ?? findNode({ getId, node: otherNode, nodeId }),
    null
  )
}

const findParentNode = &lt;NodeData&gt;({
  getId,
  node,
  nodeId,
}: {
  getId: (node: NodeShape&lt;NodeData&gt;) =&gt; number
  node: NodeShape&lt;NodeData&gt;
  nodeId: number
}): NodeShape&lt;NodeData&gt; | null =&gt; {
  if (!node.children?.length) {
    return null
  }

  const hasNode = node.children.some((otherNode) =&gt; getId(otherNode) === nodeId)

  if (hasNode) {
    return node
  }

  return node.children.reduce&lt;NodeShape&lt;NodeData&gt; | null&gt;(
    (...[acc, otherNode]) =&gt;
      acc ?? findParentNode({ getId, node: otherNode, nodeId }),
    null
  )
}

type ChartNode&lt;BaseData&gt; = BaseData &amp;
  NodeShape&lt;{
    _children: Array&lt;HierarchyPointNode&lt;ChartNode&lt;BaseData&gt;&gt;&gt; | undefined
    x: number
    x0: number
    y: number
    y0: number
  }&gt;

const margin = {
  bottom: 20,
  left: 120,
  right: 120,
  top: 20,
}

const openCloseAnimationDuration = 750
const height = 800 - margin.top - margin.bottom

const getChartNode = &lt;BaseData&gt;(
  initialNode: NodeShape&lt;BaseData&gt;
): ChartNode&lt;BaseData&gt; =&gt; ({
  ...initialNode,
  _children: undefined,
  children: (initialNode.children ?? []).map((subNode) =&gt;
    getChartNode(subNode)
  ),
  x: 0,
  x0: 0,
  y: 0,
  y0: 0,
})

const setupDrag = &lt;SelectionData&gt;(
  svgG: Selection&lt;SVGGElement, SelectionData, HTMLElement, unknown&gt;
) =&gt; {
  const translateOffset = {
    x: margin.left,
    y: height / 2,
  } as const

  const draggedState = {
    x: 0,
    y: 0,
  }

  const dragHandler = drag&lt;SVGSVGElement, unknown&gt;().on(
    &quot;drag&quot;,
    (dragEvent: D3DragEvent&lt;SVGSVGElement, unknown, unknown&gt;) =&gt; {
      draggedState.x += dragEvent.dx
      draggedState.y += dragEvent.dy

      svgG.attr(
        &quot;transform&quot;,
        `translate(${translateOffset.x + draggedState.x},${
          translateOffset.y + draggedState.y
        })`
      )
    }
  )

  svgG.attr(&quot;transform&quot;, `translate(${translateOffset.x},${translateOffset.y})`)

  const svg = select(svgG.node()!.parentNode as SVGSVGElement)

  svg.style(&quot;cursor&quot;, &quot;move&quot;).call(dragHandler)
}

type ChartConfig&lt;BaseData&gt; = {
  canBeRemoved: (node: ChartNode&lt;BaseData&gt;) =&gt; boolean
  getNodeId: (node: ChartNode&lt;BaseData&gt;) =&gt; number
  getNodeLabel: (node: ChartNode&lt;BaseData&gt;) =&gt; string
  onNodeAdd: (node: ChartNode&lt;BaseData&gt;) =&gt; NodeShape&lt;BaseData&gt;
  onNodeRemove: (node: ChartNode&lt;BaseData&gt;) =&gt; NodeShape&lt;BaseData&gt;
  rootData: NodeShape&lt;BaseData&gt;
  rootElId: string
}

const renderChart = &lt;BaseData&gt;(chartConfig: ChartConfig&lt;BaseData&gt;) =&gt; {
  const { rootData, rootElId } = chartConfig

  const rootEl = document.getElementById(rootElId) as HTMLElement

  rootEl.classList.add(styles.collapsibleTreeChart)

  const width =
    rootEl.getBoundingClientRect().width - margin.right - margin.left

  type TreeNode = HierarchyPointNode&lt;ChartNode&lt;BaseData&gt;&gt;
  type TreeLink = HierarchyPointLink&lt;ChartNode&lt;BaseData&gt;&gt;

  const dataNodeRoot = getChartNode(rootData)

  const rootHierarchy = hierarchy&lt;ChartNode&lt;BaseData&gt;&gt;(dataNodeRoot)

  rootHierarchy.data.x0 = height / 2
  rootHierarchy.data.y0 = 0

  const buildTree = treeD3&lt;ChartNode&lt;BaseData&gt;&gt;().nodeSize([40, 250])

  const rootTree = buildTree(rootHierarchy)

  rootTree.descendants().forEach((treeNode: TreeNode) =&gt; {
    treeNode.data._children = treeNode.children

    if (treeNode.depth) {
      treeNode.children = undefined
    }
  })

  const svgG = select&lt;SVGElement, TreeNode&gt;(`#${rootElId}`)
    .append(&quot;svg&quot;)
    .attr(&quot;width&quot;, width + margin.right + margin.left)
    .attr(&quot;height&quot;, height + margin.top + margin.bottom)
    .append(&quot;g&quot;)

  setupDrag(svgG)

  const commonUIOpts = {
    container: svgG,
    getInitialPosition: (node: TreeNode) =&gt; ({
      x: node.data.x0,
      y: node.data.y0,
    }),
    getPosition: (node: TreeNode) =&gt; ({ x: node.x, y: node.y }),
    linkDefaultColor: inlineStyles.linkDefaultColor,
    openCloseAnimationDuration,
  }

  const uiLink = new UILink&lt;SVGGElement, TreeLink, TreeNode&gt;(commonUIOpts)

  const uiNode = new UINode({
    ...commonUIOpts,
    displayRemoveButton: (treeNode) =&gt; chartConfig.canBeRemoved(treeNode.data),
    getNodeId: (treeNode) =&gt; chartConfig.getNodeId(treeNode.data),
    getPointingLinkForNode: (treeNode) =&gt;
      uiLink
        .getSelection()
        .filter(
          (link) =&gt;
            chartConfig.getNodeId(link.target.data) ===
            chartConfig.getNodeId(treeNode.data)
        ) as unknown as Selection&lt;SVGElement, unknown, SVGElement, unknown&gt;,
    getText: (treeNode) =&gt; chartConfig.getNodeLabel(treeNode.data),
    hasDescendants: (node) =&gt; !!node.data.children?.length,
  })

  const update = (source: TreeNode) =&gt; {
    const nodes = rootTree.descendants().reverse()
    const links = rootTree.links()

    buildTree(rootHierarchy)

    uiNode.update({
      getData: () =&gt; [
        nodes,
        (treeNode) =&gt; chartConfig.getNodeId(treeNode.data),
      ],
      onNodeAdd: (clickedTreeNode) =&gt; {
        const newNodeData = chartConfig.onNodeAdd(clickedTreeNode.data)
        const newDataNode = getChartNode(newNodeData)
        const newNodeHirarchy = hierarchy&lt;ChartNode&lt;BaseData&gt;&gt;(
          newDataNode
        ) as TreeNode

        // @ts-expect-error
        newNodeHirarchy.depth = clickedTreeNode.depth + 1
        newNodeHirarchy.parent = clickedTreeNode

        clickedTreeNode.children =
          clickedTreeNode.children ?? clickedTreeNode.data._children ?? []
        clickedTreeNode.data._children = clickedTreeNode.children
        clickedTreeNode.children.push(newNodeHirarchy)

        clickedTreeNode.data.children = clickedTreeNode.data.children ?? []
        clickedTreeNode.data.children.push(newNodeHirarchy.data)

        window.requestAnimationFrame(() =&gt; {
          update(clickedTreeNode)
        })
      },
      onNodeClick: (treeNode) =&gt; {
        treeNode.children = treeNode.children
          ? undefined
          : treeNode.data._children

        update(treeNode)
      },
      onNodeRemove: (clickedTreeNode) =&gt; {
        const parentNode = chartConfig.onNodeRemove(clickedTreeNode.data)

        const treeNode = findNode({
          getId: (node) =&gt; chartConfig.getNodeId(node.data),
          node: rootHierarchy,
          nodeId: chartConfig.getNodeId(parentNode as ChartNode&lt;BaseData&gt;),
        }) as TreeNode

        const nodeIndex = treeNode.children!.findIndex(
          (node) =&gt;
            chartConfig.getNodeId(node.data) ===
            chartConfig.getNodeId(clickedTreeNode.data)
        )

        treeNode.children!.splice(nodeIndex, 1)

        update(treeNode)
      },
      source,
    })

    uiLink.update({
      getData: () =&gt; [
        links,
        (treeLink) =&gt; chartConfig.getNodeId(treeLink.target.data),
      ],
      source,
    })

    rootTree.eachBefore((treeNode) =&gt; {
      treeNode.data.x0 = treeNode.x
      treeNode.data.y0 = treeNode.y
    })
  }

  update(rootTree)
}

export { NodeShape, findNode, findParentNode, ChartConfig, renderChart }
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Sun, 12 Dec 2021 10:45:29 GMT</p>
    </body>
  </html>
  