
  <!DOCTYPE html>
  <html>
    <head>
      <title>lines-chart.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/demos/map-distorsions/lines-chart.ts</td><td class="">98.98%</td><td class="">95%</td><td class="">591</td><td class="">585</td><td class="">6</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
  Selection,
  axisLeft,
  extent,
  line as lineD3,
  range,
  scaleLinear,
  scalePoint,
  select,
} from &quot;d3&quot;
import $ from &quot;jquery&quot;
import &quot;jquery-ui/themes/base/all.css&quot;

import { DragModule } from &quot;./lines-chart-drag&quot;
import * as styles from &quot;./map-distorsions.module.css&quot;

if (typeof window !== &quot;undefined&quot;) {
  require(&quot;jquery-ui/ui/widgets/tooltip&quot;)
}

type LineItemBase = { [dimension: string]: string }

const maxNameLength = 20
const getShortName = (name: string) =&gt;
  name.length &gt; maxNameLength ? `${name.slice(0, maxNameLength)}...` : name

const margin = {
  bottom: 20,
  left: 200,
  right: 40,
  top: 90,
}
const height = 750 - margin.top - margin.bottom
const axisYOffset = -9

const moveToFront = function appendOnEnd(this: SVGElement) {
  const parentNode = this.parentNode as HTMLElement

  parentNode.appendChild(this)
}

const colors = [&quot;#7C7CC9&quot;, &quot;#429742&quot;, &quot;#63BD28&quot;, &quot;#D14141&quot;]

enum DimensionType {
  Number = &quot;number&quot;,
  String = &quot;string&quot;,
}

type Dimension = {
  name: string
  scale: any // eslint-disable-line @typescript-eslint/no-explicit-any
  type: DimensionType
}

const filterColor = ({
  deviation,
  id,
  slope,
  svg,
}: {
  deviation: number
  id: string
  slope: number
  svg: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
}) =&gt; {
  const defs = svg.append(&quot;defs&quot;)
  const filter = defs.append(&quot;filter&quot;).attr(&quot;id&quot;, `drop-shadow-${id}`)

  filter
    .append(&quot;feOffset&quot;)
    .attr(&quot;dx&quot;, 0.5)
    .attr(&quot;dy&quot;, 0.5)
    .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
    .attr(&quot;result&quot;, &quot;offOut&quot;)

  filter
    .append(&quot;feGaussianBlur&quot;)
    .attr(&quot;in&quot;, &quot;offOut&quot;)
    .attr(&quot;result&quot;, &quot;blurOut&quot;)
    .attr(&quot;stdDeviation&quot;, deviation)

  filter
    .append(&quot;feBlend&quot;)
    .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
    .attr(&quot;in2&quot;, &quot;blurOut&quot;)
    .attr(&quot;mode&quot;, &quot;normal&quot;)

  filter
    .append(&quot;feComponentTransfer&quot;)
    .append(&quot;feFuncA&quot;)
    .attr(&quot;slope&quot;, slope)
    .attr(&quot;type&quot;, &quot;linear&quot;)
}

const colorsScale = &lt;P extends number&gt;(domain: [number, number]) =&gt; {
  const c = scaleLinear().domain(domain).range([0, 1])
  const colorScale = scaleLinear&lt;string&gt;()
    .domain(range(0, 1, 1.0 / colors.length))
    .range(
      window.location.search.includes(&quot;e2e_test=true&quot;)
        ? colors.map(() =&gt; &quot;#ccc&quot;)
        : colors
    )

  return (color: P) =&gt; colorScale(c(color))
}

type ChartConfig&lt;LineItem extends LineItemBase&gt; = {
  chartSmallTitle: string
  chartTitle: string
  dimensions: Dimension[]
  getTooltipText: (lineItem: LineItem) =&gt; string
  lines: LineItem[]
  onLineClick: (clickEvent: unknown, lineItem: LineItem) =&gt; void
  rootElId: string
}

type ChartElements = {
  background: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
  dragArea: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
  foreground: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
  svg: Selection&lt;SVGSVGElement, unknown, HTMLElement, unknown&gt;
  svgG: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
  title: Selection&lt;SVGTextElement, unknown, HTMLElement, unknown&gt;
}

class LinesChart&lt;LineItem extends LineItemBase&gt; {
  private readonly config: ChartConfig&lt;LineItem&gt;
  private readonly elements: ChartElements
  private readonly dragModule: DragModule&lt;unknown&gt;

  public constructor(config: ChartConfig&lt;LineItem&gt;) {
    this.config = config

    const { rootElId } = config

    const rootEl = document.getElementById(rootElId) as HTMLElement

    rootEl.classList.add(styles.mapDistorsionsChart)

    const svg = select(`#${rootElId}`).append(&quot;svg&quot;)
    const dragArea = svg.append(&quot;g&quot;)
    const svgG = dragArea.append(&quot;g&quot;)
    const title = svgG.append(&quot;text&quot;)
    const background = svgG.append(&quot;g&quot;)
    const foreground = svgG.append(&quot;g&quot;)

    this.elements = {
      background,
      dragArea,
      foreground,
      svg,
      svgG,
      title,
    }

    filterColor({ deviation: 2, id: &quot;lines&quot;, slope: 0.4, svg: svgG })

    this.dragModule = new DragModule({
      chart: svgG,
      dragArea,
      svg,
    })

    this.render()

    window.addEventListener(&quot;resize&quot;, this.handleResize)
  }

  private readonly handleResize = () =&gt; {
    this.render()
  }

  private render() {
    const {
      config: {
        chartSmallTitle,
        chartTitle,
        dimensions,
        getTooltipText,
        lines,
        onLineClick,
        rootElId,
      },
    } = this
    const rootEl = document.getElementById(rootElId) as HTMLElement
    const deviceMemory =
      (navigator as unknown as { deviceMemory?: number }).deviceMemory ?? 0

    rootEl.classList.add(styles.mapDistorsionsChart)

    const width = Math.max(
      700,
      rootEl.getBoundingClientRect().width - margin.left - margin.right
    )

    const isSmallScreen = width &lt; 500

    this.dragModule.setDimensions({
      marginLeft: margin.left,
      width,
    })

    const {
      elements: { background, foreground, svg, svgG, title },
    } = this

    svg
      .attr(&quot;height&quot;, height + margin.top + margin.bottom)
      .attr(&quot;width&quot;, width + margin.left + margin.right)
    svgG.attr(&quot;transform&quot;, `translate(${margin.left},${margin.top})`)

    title
      .attr(&quot;text-anchor&quot;, &quot;middle&quot;)
      .attr(&quot;transform&quot;, `translate(${width / 2},-60)`)
      .style(&quot;font-weight&quot;, &quot;bold&quot;)
      .text(isSmallScreen ? chartSmallTitle : chartTitle)

    const x = scalePoint()
      .domain(dimensions.map((dimension) =&gt; dimension.name))
      .range([0, width])

    const line = lineD3().defined((lineData) =&gt; !isNaN(lineData[1]))

    const dimensionSelection = svgG
      .selectAll(&quot;.dimension&quot;)
      .data(dimensions)
      .enter()
      .append(&quot;g&quot;)
      .attr(&quot;class&quot;, &quot;dimension&quot;)

    svgG
      .selectAll&lt;SVGGElement, Dimension&gt;(&quot;.dimension&quot;)
      .attr(&quot;transform&quot;, (dimension) =&gt; `translate(${x(dimension.name)})`)

    const colorFn = colorsScale([0, lines.length - 1])

    dimensions.forEach((dimItem) =&gt;
      dimItem.scale.range([0, height]).domain(
        dimItem.type === DimensionType.Number
          ? extent(
              lines,
              (lineItem: LineItem) =&gt; +lineItem[dimItem.name as keyof LineItem]
            )
          : lines
              .map((lineItem: LineItem) =&gt; {
                const { [dimItem.name as keyof LineItem]: name } = lineItem

                return getShortName(name)
              })
              .sort()
      )
    )

    const draw = (lineItem: LineItem) =&gt; {
      const allPoints: Array&lt;[number, number]&gt; = dimensions.map((dimItem) =&gt; {
        const { [dimItem.name as keyof LineItem]: dimensionValue } = lineItem

        return [
          x(dimItem.name) as number,
          dimItem.scale(
            typeof dimensionValue === &quot;string&quot;
              ? getShortName(dimensionValue)
              : dimensionValue
          ),
        ]
      })

      return line(allPoints)
    }

    background
      .attr(&quot;class&quot;, styles.background)
      .selectAll(&quot;path&quot;)
      .data&lt;LineItem&gt;(lines)
      .enter()
      .append(&quot;path&quot;)

    background
      .selectAll&lt;SVGPathElement, LineItem&gt;(&quot;path&quot;)
      .attr(&quot;d&quot;, draw)
      .style(&quot;cursor&quot;, &quot;pointer&quot;)
      .attr(&quot;title&quot;, getTooltipText)
      .on(&quot;click&quot;, onLineClick)

    foreground
      .attr(&quot;class&quot;, styles.foreground)
      .selectAll(&quot;path&quot;)
      .data(lines)
      .enter()
      .append(&quot;path&quot;)
      .attr(&quot;data-title&quot;, getTooltipText)

    foreground.selectAll&lt;SVGPathElement, LineItem&gt;(&quot;path&quot;).attr(&quot;d&quot;, draw)

    dimensionSelection
      .append(&quot;g&quot;)
      .attr(&quot;class&quot;, styles.axis)
      .each(function setupVerticalAxis(dimensionItem) {
        const yAxis = axisLeft(dimensionItem.scale)

        return select(this).call(yAxis)
      })
      .append(&quot;text&quot;)
      .attr(&quot;class&quot;, styles.title)
      .attr(&quot;text-anchor&quot;, &quot;middle&quot;)
      .attr(&quot;y&quot;, axisYOffset)
      .text((dimensionItem) =&gt; dimensionItem.name)

    svgG
      .select(`.${styles.axis}`)
      .selectAll&lt;SVGElement, LineItem&gt;(`text:not(.${styles.title})`)
      .attr(&quot;class&quot;, styles.label)
      .data(lines, (lineItem: LineItem) =&gt; lineItem.name)
      .style(&quot;fill&quot;, (...[, lineItemIndex]: [unknown, number]) =&gt;
        colorFn(lineItemIndex)
      )

    const linesSelection = svgG.selectAll&lt;SVGElement, LineItem&gt;(
      `.${styles.axis} text,.${styles.background} path,.${styles.foreground} path`
    )

    const mouseover = (...[, overLineItem]: [unknown, LineItem]) =&gt; {
      svgG.selectAll(`.${styles.foreground} path`).style(&quot;filter&quot;, &quot;none&quot;)
      svgG.classed(styles.active, true)
      linesSelection.classed(
        styles.inactive,
        (otherLineItem: LineItem) =&gt; otherLineItem.name !== overLineItem.name
      )

      linesSelection
        .filter(
          (otherLineItem: LineItem) =&gt; otherLineItem.name === overLineItem.name
        )
        .each(moveToFront)
    }

    const shadowFilter = deviceMemory &gt;= 8 ? &quot;url(#drop-shadow-lines)&quot; : false

    const mouseout = () =&gt; {
      svgG.selectAll(`.${styles.foreground} path`).style(&quot;filter&quot;, shadowFilter)
      svgG.classed(styles.active, false)
      linesSelection.classed(styles.inactive, false)
    }

    svgG
      .selectAll(`.${styles.foreground} path`)
      .style(&quot;filter&quot;, shadowFilter)
      .style(&quot;stroke&quot;, (...[, lineItemIndex]) =&gt; colorFn(lineItemIndex))

    linesSelection.on(&quot;mouseover&quot;, mouseover).on(&quot;mouseout&quot;, mouseout)

    $(`.${styles.background} path, .${styles.foreground} path`).tooltip({
      track: true,
    })

    this.dragModule.reset()
  }
}

export { ChartConfig, Dimension, DimensionType, LinesChart }
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:50,&quot;character&quot;:2,&quot;text&quot;:&quot;scale&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:238,&quot;character&quot;:14,&quot;text&quot;:&quot;scale&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:238,&quot;character&quot;:20,&quot;text&quot;:&quot;range&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:238,&quot;character&quot;:39,&quot;text&quot;:&quot;domain&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:260,&quot;character&quot;:18,&quot;text&quot;:&quot;scale&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/map-distorsions/lines-chart.ts&quot;,&quot;line&quot;:299,&quot;character&quot;:45,&quot;text&quot;:&quot;scale&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Wed, 01 Jun 2022 21:16:57 GMT</p>
    </body>
  </html>
  