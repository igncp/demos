
  <!DOCTYPE html>
  <html>
    <head>
      <title>fish-eye.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/demos/fish-eye/fish-eye.ts</td><td class="">99.07%</td><td class="">90%</td><td class="">535</td><td class="">530</td><td class="">5</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
  Axis,
  ScaleOrdinal,
  ScalePower,
  Selection,
  axisBottom,
  axisLeft,
  format,
  json,
  pointer as pointerD3,
  scaleLinear,
  scaleLog,
  scaleOrdinal,
  scaleSqrt,
  schemePastel2,
  select,
} from &quot;d3&quot;

import d3Fisheye, { FishEyeScale } from &quot;@/demos/_utils/fish-eye&quot;

import * as styles from &quot;./fish-eye.module.css&quot;

type DataItem = {
  income: number
  lifeExpectancy: number
  name: string
  population: number
  region: string
}
type Data = DataItem[]

const fetchData = async (): Promise&lt;Data | undefined&gt; =&gt;
  json(`${ROOT_PATH}data/d3js/fish-eye/data.json`)

const humanizeNumber = (initialN: number): string =&gt; {
  let n = initialN.toString()

  while (true) {
    const n2 = n.replace(/(\d)(\d{3})($|,|\.)/g, &quot;$1,$2$3&quot;)

    if (n === n2) {
      break
    }

    n = n2
  }

  return n
}

const margin = {
  bottom: 70,
  left: 70,
  right: 50,
  top: 80,
}
const height = 700 - margin.top - margin.bottom

type FishEyeChartOpts = {
  data: Data
  rootElId: string
}

class FishEyeChart {
  private readonly rootElId: string
  private readonly data: Data

  private width!: number

  private dom!: {
    dot?: Selection&lt;SVGCircleElement, DataItem, SVGGElement, unknown&gt;
    pointer?: Selection&lt;SVGTextElement, unknown, HTMLElement, unknown&gt;
    svg: Selection&lt;SVGGElement, unknown, HTMLElement, unknown&gt;
    xAxis?: Axis&lt;DataItem[&quot;income&quot;]&gt;
    yAxis?: Axis&lt;DataItem[&quot;lifeExpectancy&quot;]&gt;
  }

  private vars!: {
    colorScale: ScaleOrdinal&lt;string, string&gt;
    focused: boolean
    radiusScale: ScalePower&lt;number, number&gt;
    xScale: FishEyeScale
    yScale: FishEyeScale
  }

  public constructor({ data, rootElId }: FishEyeChartOpts) {
    this.rootElId = rootElId
    this.data = data

    this.setupRootEl()
    this.setVars()
    this.setDom()
  }

  public render() {
    this.setChartTitle()
    this.setBackground()
    this.setPointer()
    this.setFilter()
    this.setAxis()
    this.setLabels()
    this.setDots()
    this.setTitles()
    this.bindMousemove()
    this.bindClick()
  }

  private setupRootEl() {
    const rootEl = document.getElementById(this.rootElId) as HTMLElement

    rootEl.classList.add(styles.fishEyeChart)

    this.width =
      rootEl.getBoundingClientRect().width - margin.left - margin.right
  }

  private setDom() {
    this.dom = {
      svg: select(`#${this.rootElId}`)
        .append(&quot;svg&quot;)
        .attr(&quot;width&quot;, this.width + margin.left + margin.right)
        .attr(&quot;height&quot;, height + margin.top + margin.bottom)
        .append(&quot;g&quot;)
        .attr(&quot;transform&quot;, `translate(${margin.left},${margin.top})`),
    }
  }

  private setChartTitle() {
    this.dom.svg
      .append(&quot;text&quot;)
      .attr(&quot;class&quot;, styles.chartTitle)
      .attr(&quot;text-anchor&quot;, &quot;middle&quot;)
      .attr(&quot;transform&quot;, `translate(${this.width / 2},-40)`)
      .text(
        &quot;Income Per Capita vs &quot; +
          &quot;Life Expectancy vs Population vs Region - 180 Countries&quot;
      )
      .style(&quot;font-weight&quot;, &quot;bold&quot;)
  }

  private setVars() {
    const colorScale = scaleOrdinal&lt;string&gt;()
      .domain([
        &quot;Sub-Saharan Africa&quot;,
        &quot;South Asia&quot;,
        &quot;Middle East &amp; North Africa&quot;,
        &quot;America&quot;,
        &quot;Europe &amp; Central Asia&quot;,
        &quot;East Asia &amp; Pacific&quot;,
      ])
      .range(schemePastel2)

    const radiusScale = scaleSqrt().domain([0, 5e8]).range([5, 60])
    const xScale = d3Fisheye
      .scale(scaleLog)
      .domain([300, 1e5])
      .range([0, this.width])
    const yScale = d3Fisheye
      .scale(scaleLinear)
      .domain([20, 90])
      .range([height, 0])

    this.vars = {
      colorScale,
      focused: false,
      radiusScale,
      xScale,
      yScale,
    }
  }

  private setAxis() {
    this.dom.xAxis = axisBottom&lt;DataItem[&quot;population&quot;]&gt;(this.vars.xScale)
      .tickFormat(format(&quot;,d&quot;))
      .tickSize(-height)
    this.dom.yAxis = axisLeft&lt;DataItem[&quot;income&quot;]&gt;(this.vars.yScale).tickSize(
      -this.width
    )
    this.dom.svg
      .append(&quot;g&quot;)
      .attr(&quot;class&quot;, `x ${styles.axis}`)
      .attr(&quot;transform&quot;, `translate(0,${height})`)
      .call(this.dom.xAxis)
    this.dom.svg
      .append(&quot;g&quot;)
      .attr(&quot;class&quot;, `y ${styles.axis}`)
      .call(this.dom.yAxis)
  }

  private setBackground() {
    return this.dom.svg
      .append(&quot;rect&quot;)
      .attr(&quot;class&quot;, styles.background)
      .attr(&quot;width&quot;, this.width)
      .attr(&quot;height&quot;, height)
  }

  private setLabels() {
    this.dom.svg
      .append(&quot;text&quot;)
      .attr(&quot;class&quot;, &quot;x label&quot;)
      .attr(&quot;text-anchor&quot;, &quot;end&quot;)
      .attr(&quot;x&quot;, this.width - 26)
      .attr(&quot;y&quot;, height + 26)
      .text(&quot;income per capita, inflation-adjusted (dollars)&quot;)

    this.dom.svg
      .append(&quot;text&quot;)
      .attr(&quot;class&quot;, &quot;y label&quot;)
      .attr(&quot;text-anchor&quot;, &quot;end&quot;)
      .attr(&quot;x&quot;, -26)
      .attr(&quot;y&quot;, -40)
      .attr(&quot;dy&quot;, &quot;.75em&quot;)
      .attr(&quot;transform&quot;, &quot;rotate(-90)&quot;)
      .text(&quot;life expectancy (years)&quot;)
  }

  private setFilter() {
    const defs = this.dom.svg.append(&quot;defs&quot;)
    const filter = defs.append(&quot;filter&quot;).attr(&quot;id&quot;, `drop-shadow-circles`)

    filter
      .attr(&quot;height&quot;, &quot;500%&quot;)
      .attr(&quot;width&quot;, &quot;500%&quot;)
      .attr(&quot;x&quot;, &quot;-200%&quot;)
      .attr(&quot;y&quot;, &quot;-200%&quot;)

    filter
      .append(&quot;feOffset&quot;)
      .attr(&quot;dx&quot;, 0.5)
      .attr(&quot;dy&quot;, 0.5)
      .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
      .attr(&quot;result&quot;, &quot;offOut&quot;)

    filter
      .append(&quot;feGaussianBlur&quot;)
      .attr(&quot;in&quot;, &quot;offOut&quot;)
      .attr(&quot;result&quot;, &quot;blurOut&quot;)
      .attr(&quot;stdDeviation&quot;, 1.5)

    filter
      .append(&quot;feBlend&quot;)
      .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
      .attr(&quot;in2&quot;, &quot;blurOut&quot;)
      .attr(&quot;mode&quot;, &quot;normal&quot;)

    filter
      .append(&quot;feComponentTransfer&quot;)
      .append(&quot;feFuncA&quot;)
      .attr(&quot;slope&quot;, 0.6)
      .attr(&quot;type&quot;, &quot;linear&quot;)
  }

  private position() {
    this.dom
      .dot!.attr(&quot;cx&quot;, (d) =&gt; this.vars.xScale(d.income))
      .attr(&quot;cy&quot;, (d) =&gt; this.vars.yScale(d.lifeExpectancy))
      .attr(&quot;r&quot;, (d) =&gt; this.vars.radiusScale(d.population))
  }

  private setDots() {
    this.dom.dot = this.dom.svg
      .append(&quot;g&quot;)
      .attr(&quot;class&quot;, &quot;dots&quot;)
      .selectAll(&quot;.dot&quot;)
      .data&lt;DataItem&gt;(this.data)
      .enter()
      .append(&quot;circle&quot;)
      .attr(&quot;class&quot;, &quot;dot&quot;)
      .style(&quot;fill&quot;, (d: DataItem) =&gt; this.vars.colorScale(d.region))
      .style(&quot;filter&quot;, &quot;url(#drop-shadow-circles)&quot;)
      .style(&quot;stroke&quot;, &quot;black&quot;)
      .style(&#x27;&quot;stroke-width&quot;&#x27;, &quot;1px&quot;)
      .sort((a, b) =&gt; b.population - a.population)

    this.position()
  }

  private setTitles() {
    this.dom
      .dot!.append(&quot;title&quot;)
      .text(
        (d) =&gt;
          `${d.name}:\n- Income: ${humanizeNumber(d.income)} $/P.C.\n` +
          `- Population: ${humanizeNumber(d.population)}\n` +
          `- Life expectancy: ${d.lifeExpectancy} years`
      )
  }

  private zoom(ev: Event) {
    const mouse = pointerD3(ev)

    this.vars.xScale.distortion(2.5).focus(mouse[0])
    this.vars.yScale.distortion(2.5).focus(mouse[1])
    this.position()

    this.dom.svg.select&lt;SVGGElement&gt;(`.x.${styles.axis}`).call(this.dom.xAxis!)
    this.dom.svg.select&lt;SVGGElement&gt;(`.y.${styles.axis}`).call(this.dom.yAxis!)
  }

  private setPointer() {
    this.dom.pointer = this.dom.svg
      .append(&quot;text&quot;)
      .text(&quot;+&quot;)
      .attr(&quot;class&quot;, styles.pointer)
  }

  private bindMousemove() {
    return this.dom.svg.on(&quot;mousemove&quot;, (ev) =&gt; {
      if (!this.vars.focused) {
        this.zoom(ev)
      }
    })
  }

  private bindClick() {
    this.dom.svg.on(&quot;click&quot;, (ev: Event) =&gt; {
      this.vars.focused = !this.vars.focused

      if (this.vars.focused) {
        const pointer = pointerD3(this)

        this.dom
          .pointer!.attr(&quot;x&quot;, pointer[0])
          .attr(&quot;y&quot;, pointer[1])
          .style(&quot;opacity&quot;, 1)

        return
      }

      this.dom.pointer!.style(&quot;opacity&quot;, 0)

      this.zoom(ev)
    })
  }
}

const main = async () =&gt; {
  const data = await fetchData()

  const chart = new FishEyeChart({
    data: data as Data,
    rootElId: &quot;chart&quot;,
  })

  chart.render()
}

export default main
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/demos/fish-eye/fish-eye.ts&quot;,&quot;line&quot;:153,&quot;character&quot;:10,&quot;text&quot;:&quot;xScale&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/fish-eye/fish-eye.ts&quot;,&quot;line&quot;:156,&quot;character&quot;:7,&quot;text&quot;:&quot;range&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/fish-eye/fish-eye.ts&quot;,&quot;line&quot;:157,&quot;character&quot;:10,&quot;text&quot;:&quot;yScale&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/fish-eye/fish-eye.ts&quot;,&quot;line&quot;:160,&quot;character&quot;:7,&quot;text&quot;:&quot;range&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/fish-eye/fish-eye.ts&quot;,&quot;line&quot;:308,&quot;character&quot;:41,&quot;text&quot;:&quot;ev&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Wed, 04 Aug 2021 23:46:36 GMT</p>
    </body>
  </html>
  