
  <!DOCTYPE html>
  <html>
    <head>
      <title>chord.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/demos/chord/chord.ts</td><td class="">100.00%</td><td class="">95%</td><td class="">498</td><td class="">498</td><td class="">0</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
  BaseType,
  Selection,
  arc as arcD3,
  chord,
  csv,
  descending,
  extent,
  format,
  range,
  rgb,
  ribbon,
  scaleLinear,
  select,
} from &quot;d3&quot;

import * as styles from &quot;./chord.module.css&quot;

type CSVDataItem = {
  amount: string
  creditor: string
  debtor: string
  risk: string
}

type Country = {
  id: number
  name: string
}

type Creditor = Country
type Debtor = Country &amp; { risk: string }

type CSVParsedItem = {
  amount: string
  creditor: Creditor
  debtor: Debtor
  risk: string
}

type Debits = Array&lt;Array&lt;CSVParsedItem | null&gt;&gt;
type Credits = Array&lt;Array&lt;CSVParsedItem | null&gt;&gt;

type FinancialData = {
  credits: Credits
  debits: Debits
  fullList: Country[]
}

const fetchData = async () =&gt; {
  const originalCSVItems = (await csv(
    `${ROOT_PATH}data/d3js/chord/data.csv`
  )) as CSVDataItem[]

  const fullList: Country[] = []
  const countries: Record&lt;string, Country&gt; = {}
  const debits: Debits = []
  const credits: Credits = []

  let id = 0

  const country = (countryName: string): Country =&gt; {
    if (!(countryName in countries)) {
      countries[countryName] = {
        id,
        name: countryName,
      }

      id += 1
    }

    return countries[countryName]
  }

  const parsedList: CSVParsedItem[] = originalCSVItems.map(
    (originalCSVItem) =&gt; ({
      ...originalCSVItem,
      creditor: country(originalCSVItem.creditor),
      debtor: {
        ...country(originalCSVItem.debtor),
        risk: originalCSVItem.risk,
      },
    })
  )

  Array.from({ length: id }).forEach((...[, sourceIndex]) =&gt; {
    debits[sourceIndex] = []
    credits[sourceIndex] = []

    Array.from({ length: id }).forEach((...[, targetIndex]) =&gt; {
      debits[sourceIndex][targetIndex] = null
      credits[sourceIndex][targetIndex] = null
    })
  })

  parsedList.forEach((financialItem) =&gt; {
    debits[financialItem.creditor.id][financialItem.debtor.id] = financialItem
    credits[financialItem.debtor.id][financialItem.creditor.id] = financialItem
    fullList[financialItem.creditor.id] = financialItem.creditor
    fullList[financialItem.debtor.id] = financialItem.debtor
  })

  return {
    credits,
    debits,
    fullList,
  }
}

const addDropShadowFilter = &lt;SVGData&gt;({
  charts,
  deviation,
  name,
  slope,
}: {
  charts: Selection&lt;BaseType, SVGData, BaseType, unknown&gt;
  deviation: number
  name: string
  slope: number
}) =&gt; {
  const defs = charts.append(&quot;defs&quot;)
  const filter = defs.append(&quot;filter&quot;).attr(&quot;id&quot;, `drop-shadow-${name}`)

  filter
    .append(&quot;feOffset&quot;)
    .attr(&quot;dx&quot;, 0.5)
    .attr(&quot;dy&quot;, 0.5)
    .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
    .attr(&quot;result&quot;, &quot;offOut&quot;)

  filter
    .append(&quot;feGaussianBlur&quot;)
    .attr(&quot;in&quot;, &quot;offOut&quot;)
    .attr(&quot;result&quot;, &quot;blurOut&quot;)
    .attr(&quot;stdDeviation&quot;, deviation)

  filter
    .append(&quot;feBlend&quot;)
    .attr(&quot;in&quot;, &quot;SourceGraphic&quot;)
    .attr(&quot;in2&quot;, &quot;blurOut&quot;)
    .attr(&quot;mode&quot;, &quot;normal&quot;)

  filter
    .append(&quot;feComponentTransfer&quot;)
    .append(&quot;feFuncA&quot;)
    .attr(&quot;slope&quot;, slope)
    .attr(&quot;type&quot;, &quot;linear&quot;)
}

const colours = [
  &quot;#39B347&quot;,
  &quot;#C92E47&quot;,
  &quot;#DB704D&quot;,
  &quot;#FFA22C&quot;,
  &quot;#5E92AA&quot;,
  &quot;#F8EDD3&quot;,
]

const margin = {
  bottom: 20,
  top: 50,
}
const height = 500

type RenderChart = (o: {
  financialData: FinancialData
  rootElId: string
}) =&gt; void

const renderChart: RenderChart = ({ financialData, rootElId }) =&gt; {
  const rootEl = document.getElementById(rootElId) as HTMLElement

  rootEl.classList.add(styles.chordChart)

  const width = rootEl.getBoundingClientRect().width / 2 - 20

  const r1 = Math.min(width, height) / 2 - 4
  const r0 = r1 - 20
  const formatCurrency = format(&quot;,.3r&quot;)

  const arc = arcD3().innerRadius(r0).outerRadius(r1)
  const svg = select(`#${rootElId}`)

  const { credits, debits, fullList } = financialData

  const charts = svg
    .selectAll(&quot;div&quot;)
    .data([debits, credits])
    .enter()
    .append(&quot;div&quot;)
    .style(&quot;display&quot;, &quot;inline-block&quot;)
    .style(&quot;width&quot;, `${width}px`)
    .style(&quot;height&quot;, `${height + margin.top + margin.bottom}px`)
    .append(&quot;svg:svg&quot;)
    .attr(&quot;width&quot;, width)
    .attr(&quot;height&quot;, height + margin.top + margin.bottom)
    .append(&quot;svg:g&quot;)
    .attr(&quot;transform&quot;, `translate(${width / 2},${height / 2 + margin.top})`)

  const leftChart = charts.filter((...[, chartIndex]) =&gt; chartIndex === 0)
  const rightChart = charts.filter((...[, chartIndex]) =&gt; chartIndex === 1)

  const setLabel = ({
    chart,
    label,
  }: {
    chart: Selection&lt;BaseType, Debits, BaseType, unknown&gt;
    label: string
  }) =&gt;
    chart
      .append(&quot;text&quot;)
      .text(label)
      .attr(&quot;transform&quot;, `translate(0,${(-1 * height) / 2 - 10})`)
      .attr(&quot;class&quot;, styles.chartTitle)
      .attr(&quot;text-anchor&quot;, &quot;middle&quot;)

  setLabel({ chart: leftChart, label: &quot;Debits&quot; })
  setLabel({ chart: rightChart, label: &quot;Credits&quot; })

  addDropShadowFilter({
    charts,
    deviation: 2,
    name: &quot;chords&quot;,
    slope: 0.4,
  })
  addDropShadowFilter({
    charts,
    deviation: 3,
    name: &quot;headings&quot;,
    slope: 0.5,
  })

  const colorDomain = scaleLinear()
    .domain(extent([0, fullList.length - 1]) as [number, number])
    .range([0, 1])

  const heatmapColour = scaleLinear&lt;string&gt;()
    .domain(range(0, 1, 1.0 / colours.length))
    .range(colours)

  const fill = (chordItemIndex: number) =&gt;
    heatmapColour(colorDomain(chordItemIndex))

  charts.each(function (...[dataMatrix, chartIndex]) {
    const svgComp = select(this)
    const numberMatrix = dataMatrix.map((row) =&gt;
      row.map((cell) =&gt; (cell ? +cell.amount : 0))
    )

    const chordData = chord()
      .sortGroups(descending)
      .sortSubgroups(descending)
      .sortChords(descending)(numberMatrix)

    const ribbonLayout = ribbon().radius(r0)

    svgComp
      .selectAll(`path.${styles.chord}`)
      .data(chordData)
      .enter()
      .append(&quot;svg:path&quot;)
      .attr(&quot;class&quot;, styles.chord)
      .style(&quot;fill&quot;, (chordItem) =&gt; fill(chordItem.target.index))
      .style(&quot;filter&quot;, &quot;url(#drop-shadow-chords)&quot;)
      .style(&quot;stroke&quot;, (chordItem) =&gt; {
        const originalColor = fill(chordItem.target.index)
        const newColor = rgb(originalColor).darker()

        return newColor.formatHex()
      })
      .style(&quot;stroke-width&quot;, 2)
      .attr(&quot;d&quot;, ribbonLayout as any) // eslint-disable-line @typescript-eslint/no-explicit-any
      .append(&quot;svg:title&quot;)
      .text((chordItem) =&gt; {
        const {
          [chordItem.source.index]: sourceData,
          [chordItem.target.index]: targetData,
        } = fullList

        return `${sourceData.name} owes ${targetData.name} $${formatCurrency(
          chordItem.source.value
        )}B.`
      })

    const g = svgComp
      .selectAll(`g.${styles.group}`)
      .data(chordData.groups)
      .enter()
      .append(&quot;svg:g&quot;)
      .attr(&quot;class&quot;, styles.group)

    g.append(&quot;svg:path&quot;)
      .style(&quot;fill&quot;, (chordGroup) =&gt; fill(chordGroup.index))
      .attr(&quot;id&quot;, (chordGroup) =&gt; `group${chordGroup.index}-${chartIndex}`)
      .attr(&quot;d&quot;, arc as any) // eslint-disable-line @typescript-eslint/no-explicit-any
      .style(&quot;filter&quot;, () =&gt; &quot;url(#drop-shadow-headings)&quot;)
      .append(&quot;svg:title&quot;)
      .text(
        (chordGroup) =&gt;
          `${fullList[chordGroup.index].name} ${
            chartIndex ? &quot;owes&quot; : &quot;is owed&quot;
          } $${formatCurrency(chordGroup.value)}B.`
      )

    g.append(&quot;svg:text&quot;)
      .attr(&quot;x&quot;, 6)
      .attr(&quot;dy&quot;, 15)
      .filter((chordGroup) =&gt; chordGroup.value &gt; 150)
      .append(&quot;svg:textPath&quot;)
      .attr(
        &quot;xlink:href&quot;,
        (chordGroup) =&gt; `#group${chordGroup.index}-${chartIndex}`
      )
      .text((chordGroup) =&gt; fullList[chordGroup.index].name)
      .attr(&quot;class&quot;, styles.headingTitle)
  })
}

const main = async () =&gt; {
  const financialData = await fetchData()

  renderChart({
    financialData,
    rootElId: &quot;chart&quot;,
  })
}

export default main
</textarea><pre id="annotations" style="display:none">[]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Sun, 05 Sep 2021 17:47:04 GMT</p>
    </body>
  </html>
  