
  <!DOCTYPE html>
  <html>
    <head>
      <title>meteorites-map.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/demos/meteorites-map/meteorites-map.ts</td><td class="">99.51%</td><td class="">95%</td><td class="">617</td><td class="">614</td><td class="">3</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import {
  GeoProjection,
  Selection,
  geoMercator,
  geoPath,
  json,
  select,
  timeFormat,
  zoom,
} from &quot;d3&quot;
import anime from &quot;animejs&quot;
import qs from &quot;query-string&quot;
import { v1 as uuidv1 } from &quot;uuid&quot;

import * as styles from &quot;./meteorites-map.module.css&quot;

// @TODO:
// - review the checklist for the rest of refactors

type Point = [number, number]

type Meteorite = {
  fall: string
  geolocation: { coordinates: Point; type: &quot;Point&quot; }
  id: string
  mass: string
  name: string
  nametype: string
  recclass: string
  reclat: string
  reclong: string
  year: string
}
type MeteoriteGeo = Meteorite &amp; {
  geometry: Meteorite[&quot;geolocation&quot;]
  type: &quot;Feature&quot;
}
type Countries = {
  features: Array&lt;{
    geometry: { coordinates: Point[]; type: &quot;Polygon&quot; }
    id: string
    properties: { name: string }
    type: &quot;Feature&quot;
  }&gt;
  type: &quot;FeatureCollection&quot;
}
type State = {
  isDuringAnimation: boolean
  selectedMeteorite: string | null
}

const fetchData = async () =&gt; {
  const [countries, meteorites] = (await (Promise.all([
    json(`${ROOT_PATH}data/d3js/meteorites-map/world_countries.json`),
    json(`${ROOT_PATH}data/d3js/meteorites-map/meteorites.json`),
  ]) as unknown)) as unknown[]

  return ({
    countries,
    meteorites,
  } as unknown) as { countries: Countries; meteorites: Meteorite[] }
}

const margin = {
  bottom: 0,
  left: 0,
  right: 0,
  top: 0,
}

const svgCutBottom = 250 // to remove the south pole which doesn&#x27;t have any in the data
const height = 1000 - margin.top - margin.bottom
const modalHiddenTop = 250
const clickedMeteoriteDistortion = 20

const removeSelection = ({
  meteoritesEls,
  modal,
  state,
}: {
  meteoritesEls: Selection&lt;SVGPathElement, MeteoriteGeo, SVGGElement, unknown&gt;
  modal: Selection&lt;HTMLDivElement, unknown, HTMLElement, unknown&gt;
  state: State
}) =&gt; {
  if (state.isDuringAnimation) {
    return
  }

  state.selectedMeteorite = null

  meteoritesEls.attr(&quot;class&quot;, styles.meteorite)

  anime({
    targets: `.${styles.meteorite}`,
    translateX: 0,
    translateY: 0,
  })

  state.isDuringAnimation = true

  anime({
    complete: () =&gt; {
      state.isDuringAnimation = false
      modal.text(&quot;&quot;)
    },
    targets: `.${styles.modal}`,
    translateY: 0,
  })
}

const getNearMeteoritessWithVectors = ({
  allMeteorites,
  projectionFn,
  targetMeteorite,
}: {
  allMeteorites: MeteoriteGeo[]
  projectionFn: GeoProjection
  targetMeteorite: MeteoriteGeo
}) =&gt; {
  const targetProj = projectionFn(targetMeteorite.geometry.coordinates) as [
    number,
    number
  ]

  const nearMeteorites = allMeteorites
    .slice(0)
    .filter((otherMeteorite) =&gt; !!(otherMeteorite.geometry as unknown))
    .map((otherMeteorite) =&gt; {
      const {
        geometry: { coordinates: otherMeteoriteCoordinates },
      } = otherMeteorite
      const proj = projectionFn(otherMeteoriteCoordinates) as [number, number]
      const vector = [proj[0] - targetProj[0], proj[1] - targetProj[1]]
      const vectorLength = Math.sqrt(
        Math.pow(vector[0], 2) + Math.pow(vector[1], 2)
      )

      return {
        ...otherMeteorite,
        vector,
        vectorLength,
      }
    })
    .filter(
      (otherMeteorite) =&gt;
        otherMeteorite.vectorLength &lt; 20 &amp;&amp; otherMeteorite.vectorLength !== 0
    )
    .map((otherMeteorite) =&gt; ({
      ...otherMeteorite,
      vectorNormalized: [
        otherMeteorite.vector[0] / otherMeteorite.vectorLength,
        otherMeteorite.vector[1] / otherMeteorite.vectorLength,
      ] as [number, number],
    }))

  const nearMeteoritesSet = new Set(nearMeteorites.map((a) =&gt; a.id))

  const vectorsMap = nearMeteorites.reduce((acc, nearMeteorite) =&gt; {
    acc[nearMeteorite.id] = nearMeteorite.vectorNormalized

    return acc
  }, {} as Record&lt;string, [number, number]&gt;)

  return {
    nearMeteorites,
    nearMeteoritesSet,
    vectorsMap,
  }
}

const texts = {
  title: &quot;Meteorite landings in Earth&quot;,
}

const meteoriteClickHandler = ({
  clickedMeteorite,
  meteoritesEls,
  meteoritesGeo,
  modal,
  projectionFn,
  rootElId,
  state,
}: {
  clickedMeteorite: MeteoriteGeo
  meteoritesEls: Selection&lt;SVGPathElement, MeteoriteGeo, SVGGElement, unknown&gt;
  meteoritesGeo: MeteoriteGeo[]
  modal: Selection&lt;HTMLDivElement, unknown, HTMLElement, unknown&gt;
  projectionFn: GeoProjection
  rootElId: string
  state: State
}) =&gt; {
  if (state.isDuringAnimation) {
    return
  }

  if (state.selectedMeteorite === clickedMeteorite.id) {
    removeSelection({
      meteoritesEls,
      modal,
      state,
    })

    return
  }

  state.selectedMeteorite = clickedMeteorite.id

  const year = timeFormat(&quot;%Y&quot;)(new Date(clickedMeteorite.year))
  const mass = new Intl.NumberFormat().format(+clickedMeteorite.mass)

  modal.html(
    `
&lt;h1&gt;${clickedMeteorite.name}&lt;/h1&gt;
&lt;p&gt;Year: ${year}, Class: &lt;a href=&quot;https://www.google.com/search?${qs.stringify({
      q: `${clickedMeteorite.recclass} Meteorite Class`,
    })}&quot; target=&quot;_blank&quot;&gt;${clickedMeteorite.recclass}&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;${mass ? `Mass: ${mass}g, ` : &quot;&quot;}Name: ${clickedMeteorite.nametype}&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.google.com/search?${qs.stringify({
      q: `${clickedMeteorite.name} Meteorite ${year}`,
    })}&quot; target=&quot;_blank&quot;&gt;Click here to search&lt;/a&gt;&lt;/p&gt;
`.trim()
  )

  const { nearMeteoritesSet, vectorsMap } = getNearMeteoritessWithVectors({
    allMeteorites: meteoritesGeo,
    projectionFn,
    targetMeteorite: clickedMeteorite,
  })

  const getShouldSet0 = (idx: number) =&gt; {
    const { [idx]: animatedMeteorite } = meteoritesGeo

    return (
      animatedMeteorite.id === clickedMeteorite.id ||
      !nearMeteoritesSet.has(animatedMeteorite.id)
    )
  }

  meteoritesEls.attr(&quot;class&quot;, (meteorite) =&gt; {
    if (nearMeteoritesSet.has(meteorite.id)) {
      return `${styles.moved} ${styles.meteorite}`
    }

    return meteorite.id === clickedMeteorite.id
      ? `${styles.active} ${styles.meteorite}`
      : styles.meteorite
  })

  const getTranslateFn = (coordIdx: number) =&gt; (_el: unknown, idx: number) =&gt; {
    if (getShouldSet0(idx)) {
      return 0
    }

    const { [idx]: animatedMeteorite } = meteoritesGeo
    const { [animatedMeteorite.id]: vectorNormalized } = vectorsMap

    return vectorNormalized[coordIdx] * clickedMeteoriteDistortion
  }

  anime({
    targets: `.${styles.meteorite}`,
    translateX: getTranslateFn(0),
    translateY: getTranslateFn(1),
  })

  const rootEl = document.getElementById(rootElId) as HTMLElement
  const { top } = rootEl.getBoundingClientRect()

  anime({
    targets: `.${styles.modal}`,
    translateY: modalHiddenTop + 50 + top + window.scrollY,
  })
}

const addInfo = ({
  svg,
  width,
}: {
  svg: Selection&lt;SVGSVGElement, unknown, HTMLElement, unknown&gt;
  width: number
}) =&gt; {
  const dialogId = `dialog-${uuidv1().slice(0, 6)}`

  const group = svg
    .append(&quot;g&quot;)
    .attr(&quot;transform&quot;, `translate(${width - 50},50)`)
    .attr(&quot;class&quot;, styles.infoTrigger)

  svg.append(&quot;g&quot;).html(`
&lt;filter id=&quot;pulse&quot; x=&quot;0&quot; y=&quot;0&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt;
  &lt;feTurbulence result=&quot;cloud&quot; baseFrequency=&quot;.01&quot; seed=&quot;1&quot;  type=&quot;fractalNoise&quot; numOctaves=&quot;2&quot;&gt;
  &lt;animate attributeName=&quot;baseFrequency&quot; calcMode=&quot;paced&quot; begin=&quot;0s&quot; dur=&quot;12s&quot; values=&quot;.01;.13;.01;&quot; repeatCount=&quot;indefinite&quot;/&gt;
  &lt;/feTurbulence&gt;
  &lt;feComposite operator=&quot;in&quot; in=&quot;cloud&quot; in2=&quot;SourceGraphic&quot;/&gt;
&lt;/filter&gt;
    `)

  const dialog = select(document.body).append(&quot;div&quot;).attr(&quot;id&quot;, dialogId).html(
    `
&lt;p&gt;The green circles refer to meteorites which were moved in the map to allow seeing the selected meteorite, which is in red.&lt;/p&gt;
&lt;p&gt;You can find the &lt;a href=&quot;http://www.meteoritemarket.com/type.htm&quot;&gt;meteorites classification here&lt;/a&gt;&lt;/p&gt;
`.trim()
  )

  $(`#${dialogId}`).dialog({
    autoOpen: false,
    modal: true,
    resizable: false,
  })

  group.append(&quot;circle&quot;).attr(&quot;r&quot;, &quot;20&quot;).attr(&quot;filter&quot;, &quot;url(#pulse)&quot;)

  group.append(&quot;text&quot;).text(&quot;?&quot;)

  group.on(&quot;click&quot;, () =&gt; {
    $(`#${dialogId}`).dialog(&quot;open&quot;)
  })

  return {
    remove: () =&gt; {
      dialog.remove()
    },
  }
}

const zoomed = function (this: SVGSVGElement, e: any) {
  select(this).transition().duration(500).attr(&quot;transform&quot;, e.transform)
}

type RenderChart = (o: {
  countries: Countries
  meteorites: Meteorite[]
  rootElId: string
}) =&gt; void

const renderChart: RenderChart = ({ countries, meteorites, rootElId }) =&gt; {
  const rootEl = document.getElementById(rootElId) as HTMLElement
  const width =
    rootEl.getBoundingClientRect().width - margin.left - margin.right
  const projectionFn = geoMercator().translate([width / 2, height / 2])
  const path = geoPath().projection(projectionFn)

  const state: State = {
    isDuringAnimation: false,
    selectedMeteorite: null,
  }

  const removeSelectionFn = () =&gt; {
    removeSelection({
      meteoritesEls,
      modal,
      state,
    })
  }

  const meteoritessClickHandlerFn = (
    clickEvent: MouseEvent,
    clickedMeteorite: MeteoriteGeo
  ) =&gt; {
    clickEvent.stopPropagation()
    meteoriteClickHandler({
      clickedMeteorite,
      meteoritesEls,
      meteoritesGeo,
      modal,
      projectionFn,
      rootElId,
      state,
    })
  }

  const meteoritesGeo: MeteoriteGeo[] = meteorites.map((a) =&gt; ({
    ...a,
    geometry: a.geolocation,
    type: &quot;Feature&quot;,
  }))

  const modal = select(`#${rootElId}`)
    .append(&quot;div&quot;)
    .attr(&quot;class&quot;, styles.modal)
    .style(&quot;top&quot;, `${-modalHiddenTop}px`)

  const svg = select(`#${rootElId}`)
    .append(&quot;svg&quot;)
    .attr(&quot;width&quot;, width)
    .attr(&quot;height&quot;, height - svgCutBottom)
    .style(&quot;cursor&quot;, &quot;pointer&quot;)
    .on(&quot;click&quot;, removeSelectionFn)
    .style(&quot;transform-origin&quot;, &quot;top left&quot;)
    .call(
      zoom&lt;SVGSVGElement, unknown&gt;()
        .extent([
          [0, 0],
          [width, height],
        ])
        .on(&quot;end&quot;, zoomed)
    )

  const svgMap = svg.append(&quot;g&quot;)

  svg
    .append(&quot;text&quot;)
    .text(texts.title)
    .attr(&quot;text-anchor&quot;, &quot;middle&quot;)
    .style(&quot;font-size&quot;, &quot;20px&quot;)
    .attr(&quot;transform&quot;, `translate(${width / 2},40)`)
    .style(&quot;font-weight&quot;, &quot;bold&quot;)

  addInfo({
    svg,
    width,
  })

  const countryClass = `country-${uuidv1().slice(0, 6)}`

  svgMap
    .append(&quot;g&quot;)
    .attr(&quot;class&quot;, countryClass)
    .selectAll(&quot;path&quot;)
    .data(countries.features)
    .enter()
    .append(&quot;path&quot;)
    .attr(&quot;d&quot;, path as any)
    .attr(&quot;fill&quot;, &quot;#ccc&quot;)
    .style(&quot;stroke&quot;, &quot;white&quot;)
    .style(&quot;stroke-width&quot;, 1.5)
    .style(&quot;opacity&quot;, 0.8)
    .style(&quot;stroke&quot;, &quot;white&quot;)
    .style(&quot;stroke-width&quot;, 0.3)
    .on(&quot;click&quot;, removeSelectionFn)
    .attr(&quot;title&quot;, (country) =&gt; country.properties.name)

  const meteoritessWrapper = svgMap.append(&quot;g&quot;).on(&quot;click&quot;, removeSelectionFn)

  const meteoritesEls = meteoritessWrapper
    .selectAll(&quot;path&quot;)
    .data(meteoritesGeo)
    .enter()
    .append(&quot;path&quot;)
    .attr(&quot;d&quot;, path as any)
    .attr(&quot;class&quot;, styles.meteorite)
    .style(&quot;stroke&quot;, &quot;white&quot;)
    .style(&quot;cursor&quot;, &quot;pointer&quot;)
    .style(&quot;stroke-width&quot;, 1.5)
    .style(&quot;opacity&quot;, 0.8)
    .attr(&quot;title&quot;, (d) =&gt; d.name)
    .on(&quot;click&quot;, meteoritessClickHandlerFn)

  $(`.${styles.meteorite}`).tooltip({
    track: true,
  })

  $(`.${countryClass}`).tooltip({
    tooltipClass: styles.countryTooltip,
    track: true,
  })
}

const main = async () =&gt; {
  const { countries, meteorites } = await fetchData()

  renderChart({
    countries,
    meteorites,
    rootElId: &quot;chart&quot;,
  })
}

export default main
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/demos/meteorites-map/meteorites-map.ts&quot;,&quot;line&quot;:325,&quot;character&quot;:46,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/meteorites-map/meteorites-map.ts&quot;,&quot;line&quot;:326,&quot;character&quot;:60,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/demos/meteorites-map/meteorites-map.ts&quot;,&quot;line&quot;:326,&quot;character&quot;:62,&quot;text&quot;:&quot;transform&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Sun, 08 Aug 2021 18:22:12 GMT</p>
    </body>
  </html>
  