{"componentChunkName":"component---src-pages-d-3-js-meteorites-map-tsx","path":"/d3js/meteorites-map/","result":{"pageContext":{"demoInfo":{"dataFiles":["meteorites.json","world_countries.json"],"docs":[["animejs API reference","https://animejs.com/documentation/"],["animejs Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/animejs/index.d.ts"],["d3-zoom API reference","https://github.com/d3/d3-zoom#api-reference"],["d3-zoom Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-zoom/index.d.ts"]],"isCompleted":true,"name":"Meteorites Map","notes":["Created this chart with the data and added the interactions","Use the mouse wheel to zoom in / out, and use the mouse to pan"],"sources":["http://bl.ocks.org/micahstubbs/8e15870eb432a21f0bc4d3d527b2d14f","https://github.com/jdorfman/awesome-json-datasets#nasa"],"summary":[],"category":"d3js","files":{"cssModule":".countryTooltip {\n  background: #ffccfc;\n}\n\n.infoTrigger {\n  cursor: pointer;\n  opacity: 0.7;\n  transition: linear 0.5s opacity;\n\n  circle {\n    fill: #fff;\n    stroke: #ccc;\n  }\n\n  text {\n    fill: white;\n    font-size: 30px;\n    stroke: black;\n    text-anchor: middle;\n    transform: translate(0, 10px);\n  }\n\n  &:hover {\n    opacity: 1;\n\n    text {\n      fill: green;\n    }\n  }\n}\n\n.meteorite {\n  fill: orange;\n\n  &:hover {\n    fill: blue;\n  }\n}\n\n.meteorite.active {\n  fill: red;\n}\n\n.meteorite.moved {\n  fill: green;\n}\n\n.modal {\n  background: #fff;\n  border: 1px solid white;\n  border-radius: 5px;\n  box-shadow: 0 22px 70px 4px rgba(0, 0, 0, 0.56);\n  left: 100px;\n  padding: 15px;\n  position: absolute;\n  z-index: 10;\n}\n","demo":[{"content":"import anime from \"animejs\"\nimport {\n  GeoProjection,\n  Selection,\n  geoMercator,\n  geoPath,\n  json,\n  select,\n  timeFormat,\n  zoom,\n} from \"d3\"\nimport qs from \"query-string\"\nimport { v1 as uuidv1 } from \"uuid\"\n\nimport * as styles from \"./meteorites-map.module.css\"\n\n// @TODO:\n// refactor by separating main controller, UI and data\n\ntype Point = [number, number]\n\ntype Meteorite = {\n  fall: string\n  geolocation: { coordinates: Point; type: \"Point\" }\n  id: string\n  mass: string\n  name: string\n  nametype: string\n  recclass: string\n  reclat: string\n  reclong: string\n  year: string\n}\ntype MeteoriteGeo = Meteorite & {\n  geometry: Meteorite[\"geolocation\"] // eslint-disable-line id-denylist\n  type: \"Feature\"\n}\ntype Countries = {\n  features: Array<{\n    geometry: { coordinates: Point[]; type: \"Polygon\" } // eslint-disable-line id-denylist\n    id: string\n    properties: { name: string }\n    type: \"Feature\"\n  }>\n  type: \"FeatureCollection\"\n}\ntype State = {\n  isDuringAnimation: boolean\n  selectedMeteorite: string | null\n}\n\nconst fetchData = async () => {\n  const [countries, meteorites] = (await (Promise.all([\n    json(`${ROOT_PATH}data/d3js/meteorites-map/world_countries.json`),\n    json(`${ROOT_PATH}data/d3js/meteorites-map/meteorites.json`),\n  ]) as unknown)) as unknown[]\n\n  return ({\n    countries,\n    meteorites,\n  } as unknown) as { countries: Countries; meteorites: Meteorite[] }\n}\n\nconst margin = {\n  bottom: 0,\n  left: 0,\n  right: 0,\n  top: 0,\n}\n\nconst svgCutBottom = 250 // to remove the south pole which doesn't have any in the data\nconst height = 1000 - margin.top - margin.bottom\nconst modalHiddenTop = 250\nconst clickedMeteoriteDistortion = 20\n\nconst removeSelection = ({\n  meteoritesEls,\n  modal,\n  state,\n}: {\n  meteoritesEls: Selection<SVGPathElement, MeteoriteGeo, SVGGElement, unknown>\n  modal: Selection<HTMLDivElement, unknown, HTMLElement, unknown>\n  state: State\n}) => {\n  if (state.isDuringAnimation) {\n    return\n  }\n\n  state.selectedMeteorite = null\n\n  meteoritesEls.attr(\"class\", styles.meteorite)\n\n  anime({\n    targets: `.${styles.meteorite}`,\n    translateX: 0,\n    translateY: 0,\n  })\n\n  state.isDuringAnimation = true\n\n  anime({\n    complete: () => {\n      state.isDuringAnimation = false\n      modal.text(\"\")\n    },\n    targets: `.${styles.modal}`,\n    translateY: 0,\n  })\n}\n\nconst getNearMeteoritessWithVectors = ({\n  allMeteorites,\n  projectionFn,\n  targetMeteorite,\n}: {\n  allMeteorites: MeteoriteGeo[]\n  projectionFn: GeoProjection\n  targetMeteorite: MeteoriteGeo\n}) => {\n  const targetProj = projectionFn(targetMeteorite.geometry.coordinates) as [\n    number,\n    number\n  ]\n\n  const nearMeteorites = allMeteorites\n    .slice(0)\n    .filter((otherMeteorite) => !!(otherMeteorite.geometry as unknown))\n    .map((otherMeteorite) => {\n      const {\n        geometry: { coordinates: otherMeteoriteCoordinates },\n      } = otherMeteorite\n      const proj = projectionFn(otherMeteoriteCoordinates) as [number, number]\n      const vector = [proj[0] - targetProj[0], proj[1] - targetProj[1]]\n      const vectorLength = Math.sqrt(\n        Math.pow(vector[0], 2) + Math.pow(vector[1], 2)\n      )\n\n      return {\n        ...otherMeteorite,\n        vector,\n        vectorLength,\n      }\n    })\n    .filter(\n      (otherMeteorite) =>\n        otherMeteorite.vectorLength < 20 && otherMeteorite.vectorLength !== 0\n    )\n    .map((otherMeteorite) => ({\n      ...otherMeteorite,\n      vectorNormalized: [\n        otherMeteorite.vector[0] / otherMeteorite.vectorLength,\n        otherMeteorite.vector[1] / otherMeteorite.vectorLength,\n      ] as [number, number],\n    }))\n\n  const nearMeteoritesSet = new Set(\n    nearMeteorites.map((nearMeteorite) => nearMeteorite.id)\n  )\n\n  const vectorsMap = nearMeteorites.reduce((...[acc, nearMeteorite]) => {\n    acc[nearMeteorite.id] = nearMeteorite.vectorNormalized\n\n    return acc\n  }, {} as Record<string, [number, number]>)\n\n  return {\n    nearMeteorites,\n    nearMeteoritesSet,\n    vectorsMap,\n  }\n}\n\nconst texts = {\n  title: \"Meteorite landings in Earth\",\n}\n\nconst meteoriteClickHandler = ({\n  clickedMeteorite,\n  meteoritesEls,\n  meteoritesGeo,\n  modal,\n  projectionFn,\n  rootElId,\n  state,\n}: {\n  clickedMeteorite: MeteoriteGeo\n  meteoritesEls: Selection<SVGPathElement, MeteoriteGeo, SVGGElement, unknown>\n  meteoritesGeo: MeteoriteGeo[]\n  modal: Selection<HTMLDivElement, unknown, HTMLElement, unknown>\n  projectionFn: GeoProjection\n  rootElId: string\n  state: State\n}) => {\n  if (state.isDuringAnimation) {\n    return\n  }\n\n  if (state.selectedMeteorite === clickedMeteorite.id) {\n    removeSelection({\n      meteoritesEls,\n      modal,\n      state,\n    })\n\n    return\n  }\n\n  state.selectedMeteorite = clickedMeteorite.id\n\n  const year = timeFormat(\"%Y\")(new Date(clickedMeteorite.year))\n  const mass = new Intl.NumberFormat().format(+clickedMeteorite.mass)\n\n  modal.html(\n    `\n<h1>${clickedMeteorite.name}</h1>\n<p>Year: ${year}, Class: <a href=\"https://www.google.com/search?${qs.stringify({\n      q: `${clickedMeteorite.recclass} Meteorite Class`,\n    })}\" target=\"_blank\">${clickedMeteorite.recclass}</a></p>\n<p>${mass ? `Mass: ${mass}g, ` : \"\"}Name: ${clickedMeteorite.nametype}</p>\n<p><a href=\"https://www.google.com/search?${qs.stringify({\n      q: `${clickedMeteorite.name} Meteorite ${year}`,\n    })}\" target=\"_blank\">Click here to search</a></p>\n`.trim()\n  )\n\n  const { nearMeteoritesSet, vectorsMap } = getNearMeteoritessWithVectors({\n    allMeteorites: meteoritesGeo,\n    projectionFn,\n    targetMeteorite: clickedMeteorite,\n  })\n\n  const getShouldSet0 = (geometryIndex: number) => {\n    const { [geometryIndex]: animatedMeteorite } = meteoritesGeo\n\n    return (\n      animatedMeteorite.id === clickedMeteorite.id ||\n      !nearMeteoritesSet.has(animatedMeteorite.id)\n    )\n  }\n\n  meteoritesEls.attr(\"class\", (meteorite) => {\n    if (nearMeteoritesSet.has(meteorite.id)) {\n      return `${styles.moved} ${styles.meteorite}`\n    }\n\n    return meteorite.id === clickedMeteorite.id\n      ? `${styles.active} ${styles.meteorite}`\n      : styles.meteorite\n  })\n\n  const getTranslateFn = (coordIdx: number) => (\n    ...[, geometryIndex]: [unknown, number]\n  ) => {\n    if (getShouldSet0(geometryIndex)) {\n      return 0\n    }\n\n    const { [geometryIndex]: animatedMeteorite } = meteoritesGeo\n    const { [animatedMeteorite.id]: vectorNormalized } = vectorsMap\n\n    return vectorNormalized[coordIdx] * clickedMeteoriteDistortion\n  }\n\n  anime({\n    targets: `.${styles.meteorite}`,\n    translateX: getTranslateFn(0),\n    translateY: getTranslateFn(1),\n  })\n\n  const rootEl = document.getElementById(rootElId) as HTMLElement\n  const { top } = rootEl.getBoundingClientRect()\n\n  anime({\n    targets: `.${styles.modal}`,\n    translateY: modalHiddenTop + 50 + top + window.scrollY,\n  })\n}\n\nconst addInfo = ({\n  svg,\n  width,\n}: {\n  svg: Selection<SVGSVGElement, unknown, HTMLElement, unknown>\n  width: number\n}) => {\n  const dialogId = `dialog-${uuidv1().slice(0, 6)}`\n\n  const group = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${width - 50},50)`)\n    .attr(\"class\", styles.infoTrigger)\n\n  svg.append(\"g\").html(`\n<filter id=\"pulse\" x=\"0\" y=\"0\" width=\"100%\" height=\"100%\">\n  <feTurbulence result=\"cloud\" baseFrequency=\".01\" seed=\"1\"  type=\"fractalNoise\" numOctaves=\"2\">\n  <animate attributeName=\"baseFrequency\" calcMode=\"paced\" begin=\"0s\" dur=\"12s\" values=\".01;.13;.01;\" repeatCount=\"indefinite\"/>\n  </feTurbulence>\n  <feComposite operator=\"in\" in=\"cloud\" in2=\"SourceGraphic\"/>\n</filter>\n    `)\n\n  const dialog = select(document.body).append(\"div\").attr(\"id\", dialogId).html(\n    `\n<p>The green circles refer to meteorites which were moved in the map to allow seeing the selected meteorite, which is in red.</p>\n<p>You can find the <a href=\"http://www.meteoritemarket.com/type.htm\">meteorites classification here</a></p>\n`.trim()\n  )\n\n  $(`#${dialogId}`).dialog({\n    autoOpen: false,\n    modal: true,\n    resizable: false,\n  })\n\n  group.append(\"circle\").attr(\"r\", \"20\").attr(\"filter\", \"url(#pulse)\")\n\n  group.append(\"text\").text(\"?\")\n\n  group.on(\"click\", () => {\n    $(`#${dialogId}`).dialog(\"open\")\n  })\n\n  return {\n    remove: () => {\n      dialog.remove()\n    },\n  }\n}\n\n// eslint-disable-next-line max-params,@typescript-eslint/no-explicit-any\nconst zoomed = function (this: SVGSVGElement, zoomEvent: any) {\n  select(this).transition().duration(500).attr(\"transform\", zoomEvent.transform)\n}\n\ntype RenderChart = (o: {\n  countries: Countries\n  meteorites: Meteorite[]\n  rootElId: string\n}) => void\n\nconst renderChart: RenderChart = ({ countries, meteorites, rootElId }) => {\n  const rootEl = document.getElementById(rootElId) as HTMLElement\n  const width =\n    rootEl.getBoundingClientRect().width - margin.left - margin.right\n  const projectionFn = geoMercator().translate([width / 2, height / 2])\n  const geometryPath: any = geoPath().projection(projectionFn) // eslint-disable-line @typescript-eslint/no-explicit-any\n\n  const state: State = {\n    isDuringAnimation: false,\n    selectedMeteorite: null,\n  }\n\n  const modal = select(`#${rootElId}`)\n    .append(\"div\")\n    .attr(\"class\", styles.modal)\n    .style(\"top\", `${-modalHiddenTop}px`)\n\n  const meteoritesGeo: MeteoriteGeo[] = meteorites.map((meteoriteGeo) => ({\n    ...meteoriteGeo,\n    geometry: meteoriteGeo.geolocation, // eslint-disable-line id-denylist\n    type: \"Feature\",\n  }))\n\n  const removeSelectionFn = () => {\n    removeSelection({\n      meteoritesEls, // eslint-disable-line @typescript-eslint/no-use-before-define\n      modal,\n      state,\n    })\n  }\n\n  const meteoritessClickHandlerFn = (\n    ...[clickEvent, clickedMeteorite]: [MouseEvent, MeteoriteGeo]\n  ) => {\n    clickEvent.stopPropagation()\n    meteoriteClickHandler({\n      clickedMeteorite,\n      meteoritesEls, // eslint-disable-line @typescript-eslint/no-use-before-define\n      meteoritesGeo,\n      modal,\n      projectionFn,\n      rootElId,\n      state,\n    })\n  }\n\n  const svg = select(`#${rootElId}`)\n    .append(\"svg\")\n    .attr(\"width\", width)\n    .attr(\"height\", height - svgCutBottom)\n    .style(\"cursor\", \"pointer\")\n    .on(\"click\", removeSelectionFn)\n    .style(\"transform-origin\", \"top left\")\n    .call(\n      zoom<SVGSVGElement, unknown>()\n        .extent([\n          [0, 0],\n          [width, height],\n        ])\n        .on(\"end\", zoomed)\n    )\n\n  const svgMap = svg.append(\"g\")\n\n  svg\n    .append(\"text\")\n    .text(texts.title)\n    .attr(\"text-anchor\", \"middle\")\n    .style(\"font-size\", \"20px\")\n    .attr(\"transform\", `translate(${width / 2},40)`)\n    .style(\"font-weight\", \"bold\")\n\n  addInfo({\n    svg,\n    width,\n  })\n\n  const countryClass = `country-${uuidv1().slice(0, 6)}`\n\n  svgMap\n    .append(\"g\")\n    .attr(\"class\", countryClass)\n    .selectAll(\"path\")\n    .data(countries.features)\n    .enter()\n    .append(\"path\")\n    .attr(\"d\", geometryPath)\n    .attr(\"fill\", \"#ccc\")\n    .style(\"stroke\", \"white\")\n    .style(\"stroke-width\", 1.5)\n    .style(\"opacity\", 0.8)\n    .style(\"stroke\", \"white\")\n    .style(\"stroke-width\", 0.3)\n    .on(\"click\", removeSelectionFn)\n    .attr(\"title\", (country) => country.properties.name)\n\n  const meteoritessWrapper = svgMap.append(\"g\").on(\"click\", removeSelectionFn)\n\n  const meteoritesEls = meteoritessWrapper\n    .selectAll(\"path\")\n    .data(meteoritesGeo)\n    .enter()\n    .append(\"path\")\n    .attr(\"d\", geometryPath)\n    .attr(\"class\", styles.meteorite)\n    .style(\"stroke\", \"white\")\n    .style(\"cursor\", \"pointer\")\n    .style(\"stroke-width\", 1.5)\n    .style(\"opacity\", 0.8)\n    .attr(\"title\", (meteoriteGeo) => meteoriteGeo.name)\n    .on(\"click\", meteoritessClickHandlerFn)\n\n  $(`.${styles.meteorite}`).tooltip({\n    track: true,\n  })\n\n  $(`.${countryClass}`).tooltip({\n    tooltipClass: styles.countryTooltip,\n    track: true,\n  })\n}\n\nconst main = async () => {\n  const { countries, meteorites } = await fetchData()\n\n  renderChart({\n    countries,\n    meteorites,\n    rootElId: \"chart\",\n  })\n}\n\nexport default main\n","fileName":"meteorites-map"}],"page":{"content":"import React from \"react\"\n\nimport { DemoPageProps } from \"@/common\"\n\nimport Demo from \"@/components/demo\"\n\nimport main from \"@/demos/meteorites-map/meteorites-map\"\n\nconst Area = ({ pageContext }: DemoPageProps) => (\n  <Demo\n    links={[\"/vendors/jquery-ui/themes/base/jquery-ui.min.css\"]}\n    main={main}\n    pageContext={pageContext}\n    scripts={[\"/vendors/jquery-ui/jquery-ui.min.js\"]}\n  >\n    <div id=\"chart\" />\n  </Demo>\n)\n\nexport default Area\n","type":"tsx"}},"key":"meteorites-map"},"meta":{"description":"World map chart with information about meteorite landings. It uses D3, animejs and other libraries, and it is highly interactive. It also informs about each meteorite properties like the name or classification."}}},"staticQueryHashes":[]}