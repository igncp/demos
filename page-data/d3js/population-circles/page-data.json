{"componentChunkName":"component---src-pages-d-3-js-population-circles-tsx","path":"/d3js/population-circles/","result":{"pageContext":{"demoInfo":{"dataFiles":["data.json"],"docs":[["d3-scale API reference","https://github.com/d3/d3-scale#api-reference"],["d3-scale Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-scale/index.d.ts"],["d3-hierarchy API reference","https://github.com/d3/d3-hierarchy#api-reference"],["d3-hierarchy Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-hierarchy/index.d.ts"],["d3-selection API reference","https://github.com/d3/d3-selection#api-reference"],["d3-selection Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-selection/index.d.ts"],["d3-scale-chromatic API reference","https://github.com/d3/d3-scale-chromatic#api-reference"],["d3-scale-chromatic Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-scale-chromatic/index.d.ts"],["d3-transition API reference","https://github.com/d3/d3-transition#api-reference"],["d3-transition Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-transition/index.d.ts"],["d3-zoom API reference","https://github.com/d3/d3-zoom#api-reference"],["d3-zoom Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/d3-zoom/index.d.ts"],["animejs API reference","https://animejs.com/documentation/"],["animejs Types","https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/animejs/index.d.ts"],["viewBox SVG attribute","https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox"]],"isCompleted":true,"name":"Population Circles","notes":["It has transitions for nested elements: by using enter/exist/transition approach plus (new) `.data(d => d)`","Click a circle while pressing the Control key to open a search window for a municipality","The population JSON data has been parsed and saved in the file to rename properties and remove unused","You can use the mouse to zoom","TODO: Fix zooming function","TODO: Review checklist"],"sources":["https://observablehq.com/@d3/bubble-chart?collection=@d3/d3-hierarchy","https://datos.gob.es/en/catalogo/ea0010587-malaga-poblacion-por-municipios-y-sexo-anual-cifras-oficiales-de-poblacion-de-los-municipios-espanoles-revision-del-padron-municipal-identificador-api-2882"],"summary":[],"category":"d3js","files":{"cssModule":".radio {\n  cursor: pointer;\n  display: inline-block;\n\n  input {\n    margin-right: 5px;\n  }\n\n  input,\n  label {\n    cursor: pointer;\n  }\n}\n\n.slider {\n  margin-bottom: 20px;\n\n  div {\n    background-color: lightblue;\n  }\n}\n\n.circle {\n  fill-opacity: 0.8;\n  stroke-width: 0;\n}\n\n.header {\n  font-size: 20px;\n}\n","demo":[{"content":"import { select } from \"d3\"\nimport hotkeys from \"hotkeys-js\"\n\nimport { renderChart } from \"./population-circles-chart\"\nimport {\n  Municipality,\n  createChartConfig,\n  createState,\n  fetchData,\n} from \"./population-circles-chart-data\"\n\nconst main = async () => {\n  hotkeys(\"control\", () => {})\n\n  const municipalities = await fetchData()\n\n  const state = createState()\n  const chartConfig = createChartConfig(municipalities, state)\n\n  const { updateChart } = renderChart<Municipality>(chartConfig)\n\n  select(\"form\").on(\"change\", (changeEvent) => {\n    state.populationType = changeEvent.target.value\n    updateChart()\n  })\n\n  $(\".population-slider\").slider({\n    change: (...[, { values: populationValues }]) => {\n      const newValues = (populationValues as [number, number]).map(\n        (v) => v / 100\n      ) as [number, number]\n\n      state.populationRange = newValues\n      updateChart()\n    },\n    range: true,\n    values: [0, 100], // eslint-disable-line id-denylist\n  })\n\n  const max = municipalities[0].values.total.length - 1\n\n  $(\".time-slider\").slider({\n    change: (...[, { value: timeRangeIndex }]) => {\n      state.timeRangeIndex = timeRangeIndex as number\n      updateChart()\n    },\n    max,\n    min: 0,\n    value: 0, // eslint-disable-line id-denylist\n  })\n}\n\nexport default main\n","fileName":"population-circles"},{"content":"import { json } from \"d3\"\nimport hotkeys from \"hotkeys-js\"\nimport qs from \"query-string\"\n\nimport { ChartConfig } from \"./population-circles-chart\"\n\ntype PopulationRecord = {\n  count: number\n  date: string\n}\n\nexport type Municipality = {\n  name: string\n  values: {\n    females: PopulationRecord[]\n    males: PopulationRecord[]\n    total: PopulationRecord[]\n  }\n}\n\ntype PopulationType = keyof Municipality[\"values\"]\n\ntype State = {\n  populationRange: [number, number]\n  populationType: PopulationType\n  timeRangeIndex: number\n}\n\nexport const createState = (): State => ({\n  populationRange: [0, 1],\n  populationType: \"total\",\n  timeRangeIndex: 0,\n})\n\nexport const fetchData = () =>\n  (json(\n    `${ROOT_PATH}data/d3js/population-circles/data.json`\n  ) as unknown) as Promise<Municipality[]>\n\nconst formatPopulation = (populationNum: number) =>\n  Number(populationNum.toFixed(0)).toLocaleString(undefined, {\n    maximumFractionDigits: 0,\n    minimumFractionDigits: 0,\n  })\n\nconst typeNouns: Record<string, string> = {\n  females: \"females\",\n  males: \"males\",\n  total: \"people\",\n}\n\nconst getYearStr = (dateStr: string) => new Date(dateStr).getFullYear()\n\nexport const createChartConfig = (\n  municipalities: Municipality[],\n  state: State\n): ChartConfig<Municipality> => {\n  type Config = ChartConfig<Municipality>\n\n  const colorDomain = municipalities.map((municipality) => municipality.name)\n  const getStringForColor = (municipality: Municipality) => municipality.name\n\n  const getEmptyItem = (): Municipality => ({\n    name: \"\",\n    values: {\n      females: [],\n      males: [],\n      total: [],\n    },\n  })\n\n  const getItemMetric: Config[\"getItemMetric\"] = (\n    municipality: Municipality\n  ) => {\n    if (!(municipality.values as unknown)) {\n      return 1\n    }\n\n    const {\n      values: {\n        [state.populationType]: { [state.timeRangeIndex]: valueItem },\n      },\n    } = municipality\n\n    return !(valueItem as unknown) ? 0 : valueItem.count\n  }\n\n  const getChartItems: Config[\"getChartItems\"] = () => {\n    const { populationRange, populationType, timeRangeIndex } = state\n    const itemsWithCount = municipalities.filter((municipality) => {\n      const {\n        values: {\n          [populationType]: { [timeRangeIndex]: valueItem },\n        },\n      } = municipality\n\n      return !!(valueItem as unknown)\n    })\n\n    const dataValues = itemsWithCount.map((municipality) => {\n      const {\n        values: {\n          [populationType]: { [timeRangeIndex]: dataItem },\n        },\n      } = municipality\n\n      return dataItem.count\n    })\n\n    const valueToIdx = dataValues.reduce((acc, val, idx) => {\n      acc[val] = acc[val] ?? []\n      acc[val]!.push(idx)\n\n      return acc\n    }, {} as Record<string, number[] | undefined>)\n\n    const sortedDataValues = dataValues.sort(\n      (municipalityAValue, municipalityBValue) =>\n        municipalityAValue - municipalityBValue\n    )\n\n    const percentiles = sortedDataValues.reduce((acc, val, idx) => {\n      const percentile = idx / sortedDataValues.length\n      const { [val]: unsortedIndexes } = valueToIdx\n\n      unsortedIndexes!.forEach((idx2: number) => {\n        acc[idx2] = percentile\n      })\n\n      return acc\n    }, [] as number[])\n\n    const filteredData = itemsWithCount.filter((_municipality, idx) => {\n      const { [idx]: percentile } = percentiles\n\n      return (\n        typeof percentile === \"number\" &&\n        percentile >= populationRange[0] &&\n        percentile <= populationRange[1]\n      )\n    })\n\n    return filteredData\n  }\n\n  const getHeaderText: Config[\"getHeaderText\"] = ({ chartItems }) => {\n    const {\n      values: {\n        [state.populationType]: {\n          [state.timeRangeIndex]: { date },\n        },\n      },\n    } = chartItems[0]\n\n    const year = getYearStr(date)\n\n    const populationTotal = chartItems.reduce(\n      (acc, circleData) =>\n        acc +\n        circleData.values[state.populationType][state.timeRangeIndex].count,\n      0\n    )\n\n    const populationText = `${formatPopulation(populationTotal)} ${\n      typeNouns[state.populationType]\n    }`\n\n    const { length: totalNum } = chartItems.filter(\n      (chartItem) =>\n        chartItem.values[state.populationType].length >=\n        state.timeRangeIndex + 1\n    )\n\n    return `Population in Malaga: ${year} - ${populationText}${\n      state.populationRange[0] === 0 && state.populationRange[1] === 1\n        ? \"\"\n        : ` - From ${(state.populationRange[0] * 100).toFixed(\n            0\n          )} percentile to ${(state.populationRange[1] * 100).toFixed(\n            0\n          )} percentile`\n    } - ${totalNum} municipalities`\n  }\n\n  const getItemId: Config[\"getItemId\"] = (municipality) => municipality.name\n\n  const getItemTitle: Config[\"getItemTitle\"] = ({ circleData }) => {\n    const {\n      values: {\n        [state.populationType]: { [state.timeRangeIndex]: valueItem },\n      },\n    } = circleData\n\n    if (!valueItem as unknown) {\n      return \"\"\n    }\n\n    const { [state.populationType]: itemsName } = typeNouns\n\n    return `${circleData.name} - ${formatPopulation(\n      valueItem.count\n    )} ${itemsName} - ${getYearStr(valueItem.date)}`\n  }\n\n  const getItemLabel: Config[\"getItemLabel\"] = (municipality) =>\n    municipality.name[0]!\n\n  const getIsSmall = () => state.populationType !== \"total\"\n\n  const onClick: Config[\"onClick\"] = (municipality) => {\n    if (!hotkeys.isPressed(\"control\")) {\n      return\n    }\n\n    window.open(\n      `https://www.google.com/search?${qs.stringify({\n        q: `Malaga ${municipality.name}`,\n      })}`\n    )\n  }\n\n  return {\n    colorDomain,\n    getChartItems,\n    getEmptyItem,\n    getHeaderText,\n    getIsSmall,\n    getItemId,\n    getItemLabel,\n    getItemMetric,\n    getItemTitle,\n    getStringForColor,\n    onClick,\n    rootElId: \"chart\",\n  }\n}\n","fileName":"population-circles-chart-data"},{"content":"import anime from \"animejs\"\nimport chroma from \"chroma-js\"\nimport {\n  BaseType,\n  D3ZoomEvent,\n  HierarchyCircularNode,\n  Selection,\n  Transition,\n  easeCircleInOut,\n  easeSinInOut,\n  hierarchy,\n  pack,\n  scaleOrdinal,\n  schemeSet3,\n  select,\n  zoom,\n} from \"d3\"\n\nimport * as styles from \"./population-circles.module.css\"\n\nconst dropShadowBaseId = \"dropShadowBase\"\n\nconst margin = {\n  bottom: 0,\n  left: 0,\n  right: 0,\n  top: 70,\n}\nconst height = 400\n\nexport type ChartConfig<CircleData> = {\n  colorDomain: string[]\n  getChartItems: () => CircleData[]\n  getEmptyItem: () => CircleData\n  getHeaderText: (o: { chartItems: CircleData[] }) => string\n  getIsSmall: () => boolean\n  getItemId: (circleData: CircleData) => string\n  getItemLabel: (circleData: CircleData) => string\n  getItemMetric: (circleData: CircleData) => number\n  getItemTitle: (o: { circleData: CircleData }) => string\n  getStringForColor: (circleData: CircleData) => string\n  onClick: (m: CircleData) => void\n  rootElId: string\n}\n\ntype RenderChartReturn = {\n  updateChart: () => void\n}\n\ntype AddDropShadow = (o: {\n  deviation: number\n  name: string\n  slope: number\n  svg: Selection<SVGSVGElement, unknown, HTMLElement, unknown>\n}) => void\n\nconst addDropShadow: AddDropShadow = ({ deviation, name, slope, svg }) => {\n  svg.append(\"filter\").html(`\n<filter id=\"${name}\" height=\"130%\">\n  <feGaussianBlur in=\"SourceAlpha\" stdDeviation=\"${deviation}\"/>\n  <feOffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>\n  <feComponentTransfer>\n    <feFuncA type=\"linear\" slope=\"${slope}\"/>\n  </feComponentTransfer>\n  <feMerge>\n    <feMergeNode/>\n    <feMergeNode in=\"SourceGraphic\"/>\n  </feMerge>\n</filter>\n`)\n}\n\nexport const renderChart = <CircleData>(\n  chartConfig: ChartConfig<CircleData>\n): RenderChartReturn => {\n  type ChartNode = HierarchyCircularNode<CircleData>\n\n  const chartEl = document.getElementById(chartConfig.rootElId) as HTMLElement\n  const { width } = chartEl.getBoundingClientRect()\n\n  const lastPosition = { k: 1, x: 0, y: 0 }\n\n  // this zoom function is not working well in all directions\n  // eslint-disable-next-line max-params\n  const zoomed = function (\n    this: SVGSVGElement,\n    zoomEvent: D3ZoomEvent<SVGSVGElement, unknown>\n  ) {\n    const transition = select(this).transition().duration(150)\n    let {\n      transform: { x, y },\n    } = zoomEvent\n    const {\n      transform: { k },\n    } = zoomEvent\n\n    if (k !== lastPosition.k) {\n      x = lastPosition.x\n      y = lastPosition.y\n    }\n\n    transition.attr(\"transform\", `translate(${x}, ${y}) scale(${k})`)\n\n    lastPosition.k = k\n    lastPosition.x = x\n    lastPosition.y = y\n  }\n\n  const color = scaleOrdinal<string, string>()\n    .domain(chartConfig.colorDomain)\n    .range(schemeSet3)\n\n  const zoomBehavior = zoom<SVGSVGElement, unknown>()\n    .extent([\n      [0, 0],\n      [width / 2, height / 2],\n    ])\n    .on(\"end\", zoomed)\n\n  const svg = select(`#${chartConfig.rootElId}`)\n    .append(\"svg\")\n    .attr(\"viewBox\", [0, 0, width, height + margin.top].join(\", \"))\n    .attr(\"font-size\", 10)\n    .attr(\"font-family\", \"sans-serif\")\n    .attr(\"text-anchor\", \"middle\")\n    .call(zoomBehavior)\n\n  addDropShadow({ deviation: 2, name: dropShadowBaseId, slope: 0.5, svg })\n\n  const header = svg\n    .append(\"text\")\n    .attr(\"class\", styles.header)\n    .text(\"\")\n    .attr(\"transform\", `translate(${width / 2}, 50)`)\n\n  const svgContent = svg\n    .append(\"g\")\n    .attr(\"transform\", `translate(${margin.left}, ${margin.top})`)\n\n  const transitionChart = () => {\n    const filteredData = chartConfig.getChartItems()\n    const hoverAnimations: { [k: string]: anime.AnimeInstance | null } = {}\n\n    const structure = hierarchy({\n      ...chartConfig.getEmptyItem(),\n      children: filteredData,\n    }).sum(chartConfig.getItemMetric)\n\n    const isSmall = chartConfig.getIsSmall()\n\n    const root = pack<CircleData>()\n      .size(isSmall ? [width / 2, height / 2] : [width, height])\n      .padding(3)(structure)\n\n    const leaves = root.leaves()\n\n    header.text(\n      chartConfig.getHeaderText({\n        chartItems: filteredData,\n      })\n    )\n\n    const getDataKey = (node: unknown) =>\n      chartConfig.getItemId((node as HierarchyCircularNode<CircleData>).data)\n\n    const leaf = svgContent.selectAll(\".leaf\").data(leaves, getDataKey)\n\n    leaf.exit().remove()\n\n    const getTitle = (node: HierarchyCircularNode<CircleData>) =>\n      chartConfig.getItemTitle({\n        circleData: node.data,\n      })\n\n    leaf\n      .attr(\"title\", getTitle)\n      .transition()\n      .duration(1000)\n      .ease(easeCircleInOut)\n      .attr(\"transform\", (chartNode) => {\n        if (isSmall) {\n          return `translate(${chartNode.x + width / 4},${\n            chartNode.y + height / 4\n          })`\n        }\n\n        return `translate(${chartNode.x + 1},${chartNode.y + 1})`\n      })\n\n    const enter = leaf\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", \"leaf\")\n      .attr(\"title\", getTitle)\n      .attr(\"transform\", (node) => `translate(${node.x + 1},${node.y + 1})`)\n      .on(\"mouseenter\", function (...[, node]) {\n        const selection = select(this).select(`.${styles.circle}`)\n\n        select(this)\n          .select(\".letter\")\n          .attr(\"filter\", `url(#${dropShadowBaseId})`)\n\n        const id = chartConfig.getItemId(node.data)\n\n        const hoverAnimation = anime({\n          complete: () => {\n            hoverAnimations[id] = null\n          },\n          strokeWidth: \"5px\",\n          targets: [selection.node()],\n        })\n\n        hoverAnimations[id] = hoverAnimation\n      })\n      .on(\"mouseleave\", function (...[, node]) {\n        const selection = select(this).select(`.${styles.circle}`)\n\n        select(this).select(\".letter\").attr(\"filter\", null)\n\n        const id = chartConfig.getItemId(node.data)\n        const { [id]: hoverAnimation } = hoverAnimations\n\n        if (hoverAnimation) {\n          hoverAnimation.seek(0)\n          anime.remove(selection.node())\n          hoverAnimations[id] = null\n        }\n\n        anime({\n          strokeWidth: \"0px\",\n          targets: [selection.node()],\n        })\n      })\n      .on(\"click\", (...[, node]) => {\n        chartConfig.onClick(node.data)\n      })\n\n    const generateColor = (node: HierarchyCircularNode<CircleData>) =>\n      color(chartConfig.getStringForColor(node.data))\n\n    const generateDarkerColor = (node: ChartNode) => {\n      const baseColor = generateColor(node)\n\n      return chroma(baseColor).darken(1.5).hex()\n    }\n\n    type ChartTransition = Transition<BaseType, ChartNode, BaseType, ChartNode>\n\n    const setupLetter = (\n      letter:\n        | ChartTransition\n        | Selection<SVGTextElement, ChartNode, SVGGElement, unknown>\n    ) => {\n      const letterSelection = letter.text((node) =>\n        chartConfig.getItemLabel(node.data)\n      ) as ChartTransition\n\n      letterSelection\n        .style(\"font-size\", (node) => `${node.r.toFixed(0)}px`)\n        .attr(\"dy\", (node) => node.r / 3)\n        .attr(\"fill\", generateDarkerColor)\n    }\n\n    const setupCircle = (\n      circle:\n        | ChartTransition\n        | Selection<SVGCircleElement, ChartNode, SVGGElement, unknown>\n    ) => {\n      const elem = circle.attr(\"r\", (node) => node.r!) as ChartTransition\n\n      elem.attr(\"fill\", generateColor).attr(\"stroke\", generateDarkerColor)\n    }\n\n    setupCircle(enter.append(\"circle\").attr(\"class\", styles.circle))\n\n    setupLetter(enter.append(\"text\").attr(\"class\", \"letter\"))\n\n    const forwardData = (node: ChartNode) => node\n\n    const circles = leaf\n      .selectAll(`.${styles.circle}`)\n      .data(forwardData, getDataKey)\n    const texts = leaf.selectAll(\".letter\").data(forwardData, getDataKey)\n\n    setupCircle(circles.transition().duration(1000).ease(easeSinInOut))\n\n    setupLetter(texts.transition().duration(1000).ease(easeSinInOut))\n\n    $(\".leaf\").tooltip({\n      track: true,\n    })\n  }\n\n  transitionChart()\n\n  return {\n    updateChart: transitionChart,\n  }\n}\n","fileName":"population-circles-chart"}],"page":{"content":"import React from \"react\"\n\nimport { DemoPageProps } from \"@/common\"\n\nimport Demo from \"@/components/demo\"\n\nimport main from \"@/demos/population-circles/population-circles\"\nimport * as styles from \"@/demos/population-circles/population-circles.module.css\"\n\nconst PopulationCircles = ({ pageContext }: DemoPageProps) => (\n  <Demo\n    links={[\"/vendors/jquery-ui/themes/base/jquery-ui.min.css\"]}\n    main={main}\n    pageContext={pageContext}\n    scripts={[\"/vendors/jquery-ui/jquery-ui.min.js\"]}\n  >\n    <form>\n      {[\n        { id: \"total\", label: \"Total\" },\n        { id: \"males\", label: \"Males\" },\n        { id: \"females\", label: \"Females\" },\n      ].map((...[{ id, label }, radioIndex]) => (\n        <div className={styles.radio} key={id}>\n          <input\n            defaultChecked={radioIndex === 0}\n            id={id}\n            name=\"type\"\n            type=\"radio\"\n            value={id}\n          />\n          <label htmlFor={id}>{label}</label>\n        </div>\n      ))}\n    </form>\n    <div className={styles.slider}>\n      <p>Time</p>\n      <div className=\"time-slider\" />\n    </div>\n    <div className={styles.slider}>\n      <p>Population Percentile</p>\n      <div className=\"population-slider\" />\n    </div>\n    <div id=\"chart\" />\n  </Demo>\n)\n\nexport default PopulationCircles\n","type":"tsx"}},"key":"population-circles"},"meta":{"description":""}}},"staticQueryHashes":[]}